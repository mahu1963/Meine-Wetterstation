<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Wetterstation Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ---------------------- */
/*   DARK MODE SYSTEM     */
/* ---------------------- */
:root {
  --bg: #f0f0f0;
  --fg: #000;
  --card: #fff;
}

.dark {
  --bg: #121212;
  --fg: #eee;
  --card: #1e1e1e;
}

body {
  font-family: Arial;
  background: var(--bg);
  color: var(--fg);
  padding: 20px;
  transition: background 0.3s, color 0.3s;
}

#container {
  max-width: 480px;
  margin: 0 auto;
}

canvas {
  max-width: 100%;
  width: 100%;
  height: auto !important;
  background: var(--card);
  padding: 10px;
  border-radius: 10px;
}

button {
  padding: 10px 20px;
  margin-right: 10px;
  cursor: pointer;
}

.hidden { display: none; }

/* LIVE ICON */
#livebox {
  display: flex;
  align-items: center;
  font-size: 22px;
  margin-bottom: 10px;
}

#live-icon {
  font-size: 32px;
  margin-right: 12px;
  animation: pulse 1.2s infinite;
}

@keyframes pulse {
  0% { opacity: 0.4; }
  50% { opacity: 1; }
  100% { opacity: 0.4; }
}

#forecast-box {
  background: var(--card);
  padding: 10px;
  border-radius: 10px;
  margin-top: 20px;
}
</style>
</head>

<body>
<div id="container">

<h1>üå§ Wetterstation Dashboard</h1>

<!-- DARK MODE BUTTON -->
<button onclick="toggleDark()">üåô / ‚òÄÔ∏è</button>

<!-- LIVE-BEREICH -->
<h2 id="livebox">
  <span id="live-icon">‚ùì</span>
  Aktuelle Messwerte
</h2>

<div id="livevalues">
  <p id="live-temp"></p>
  <p id="live-hum"></p>
  <p id="live-press"></p>
  <p id="live-trend"></p>
  <p id="minmax"></p>
</div>

<!-- TABS -->
<div class="tab">
  <button onclick="showTab('24h')">24h</button>
  <button onclick="showTab('week')">Woche</button>
  <button onclick="showTab('month')">Monat</button>
  <button onclick="showTab('year')">Jahr</button>
</div>

<!-- DIAGRAMME -->
<div id="24h"><canvas id="chart24h"></canvas></div>
<div id="week" class="hidden"><canvas id="chartWeek"></canvas></div>
<div id="month" class="hidden"><canvas id="chartMonth"></canvas></div>
<div id="year" class="hidden"><canvas id="chartYear"></canvas></div>

<!-- REGENRADAR -->
<h2>Regenradar</h2>
<iframe 
  src="https://www.zamg.ac.at/wetter/radar" 
  width="100%" 
  height="400" 
  style="border:0; border-radius:10px;">
</iframe>

<!-- OPENWEATHER VORHERSAGE -->
<div id="forecast-box">
  <h2>OpenWeather Vorhersage (5 Tage)</h2>
  <div id="forecast"></div>
</div>

</div>

<script type="module">
/* ---------------------- */
/*   FIREBASE IMPORTS     */
/* ---------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ---------------------- */
/*   FIREBASE CONFIG      */
/* ---------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBZowt7QFJ6AzSxaDQIcvw9oGEA6F-1-AM",
  authDomain: "meine-wetterstation.firebaseapp.com",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "meine-wetterstation"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------------------- */
/*   DARK MODE            */
/* ---------------------- */
function toggleDark() {
  document.body.classList.toggle("dark");
}

/* ---------------------- */
/*   LIVE-WERTE           */
/* ---------------------- */
const liveRef = ref(db, "weather/live");
let lastTemp = null;

onValue(liveRef, (snap) => {
  const d = snap.val();
  if (!d) return;

  const t = d.temperature;

  document.getElementById("live-temp").textContent =
    "üå° Temperatur: " + t.toFixed(1) + " ¬∞C";

  document.getElementById("live-hum").textContent =
    "üíß Luftfeuchtigkeit: " + d.humidity.toFixed(1) + " %";

  document.getElementById("live-press").textContent =
    "üåç Luftdruck: " + d.pressure.toFixed(1) + " hPa";

  /* TREND */
  if (lastTemp !== null) {
    if (t > lastTemp) document.getElementById("live-trend").textContent = "üìà Temperatur steigt";
    else if (t < lastTemp) document.getElementById("live-trend").textContent = "üìâ Temperatur f√§llt";
    else document.getElementById("live-trend").textContent = "‚û°Ô∏è stabil";
  }
  lastTemp = t;

  /* LIVE ICON */
  let icon = "‚ùì";
  if (d.openweather && d.openweather.weather && d.openweather.weather[0]) {
    const w = d.openweather.weather[0].main.toLowerCase();
    if (w.includes("clear")) icon = "‚òÄÔ∏è";
    else if (w.includes("cloud")) icon = "‚òÅÔ∏è";
    else if (w.includes("rain")) icon = "üåßÔ∏è";
    else if (w.includes("snow")) icon = "‚ùÑÔ∏è";
  }
  document.getElementById("live-icon").textContent = icon;
});

/* ---------------------- */
/*   MIN/MAX 24h          */
/* ---------------------- */
async function updateMinMax() {
  const snap = await get(ref(db, "weather/history/24h"));
  const data = snap.val();
  if (!data) return;

  const temps = Object.values(data).map(v => v.t);

  const min = Math.min(...temps).toFixed(1);
  const max = Math.max(...temps).toFixed(1);

  document.getElementById("minmax").textContent =
    "Min/Max (24h): " + min + "¬∞C / " + max + "¬∞C";
}

setInterval(updateMinMax, 60000);
updateMinMax();

/* ---------------------- */
/*   HISTORY DIAGRAMME    */
/* ---------------------- */
async function loadHistory(path) {
  const snap = await get(ref(db, path));
  const data = snap.val();
  if (!data) return { labels: [], temps: [], hums: [], press: [] };

  const labels = [];
  const temps = [];
  const hums = [];
  const press = [];

  for (const ts in data) {
    const d = new Date(ts * 1000);
    labels.push(d.toLocaleString("de-DE"));
    temps.push(data[ts].t);
    hums.push(data[ts].h);
    press.push(data[ts].p);
  }

  return { labels, temps, hums, press };
}

async function drawChart(canvasId, path, title) {
  const ctx = document.getElementById(canvasId).getContext("2d");
  const { labels, temps, hums, press } = await loadHistory(path);

  new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        { label: "Temperatur (¬∞C)", data: temps, borderColor: "red", yAxisID: "y" },
        { label: "Luftfeuchtigkeit (%)", data: hums, borderColor: "blue", yAxisID: "y1" },
        { label: "Luftdruck (hPa)", data: press, borderColor: "green", yAxisID: "y2" }
      ]
    },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: title } },
      scales: {
        y: { type: "linear", position: "left" },
        y1: { type: "linear", position: "right" },
        y2: { type: "linear", position: "right", grid: { drawOnChartArea: false } }
      }
    }
  });
}

window.onload = () => {
  drawChart("chart24h", "weather/history/24h", "Letzte 24 Stunden");
  drawChart("chartWeek", "weather/history/week", "Letzte 7 Tage");
  drawChart("chartMonth", "weather/history/month", "Letzter Monat");
  drawChart("chartYear", "weather/history/year", "Letztes Jahr");
};

/* ---------------------- */
/*   OPENWEATHER FORECAST */
/* ---------------------- */
async function loadForecast() {
  const snap = await get(ref(db, "weather/live/openweather"));
  const ow = snap.val();
  if (!ow) return;

  const lat = ow.coord.lat;
  const lon = ow.coord.lon;
  const key = ow.apiKey || ""; // optional

  const url =
    `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=de&appid=${key}`;

  const res = await fetch(url);
  const data = await res.json();

  const box = document.getElementById("forecast");
  box.innerHTML = "";

  data.list.slice(0, 10).forEach(item => {
    const d = new Date(item.dt * 1000);
    const div = document.createElement("div");
    div.innerHTML =
      `<b>${d.toLocaleString("de-DE")}</b><br>
       üå° ${item.main.temp.toFixed(1)}¬∞C<br>
       üå¶ ${item.weather[0].description}<br><br>`;
    box.appendChild(div);
  });
}

loadForecast();

/* ---------------------- */
/*   TAB SWITCHING        */
/* ---------------------- */
window.showTab = function(name) {
  document.getElementById("24h").classList.add("hidden");
  document.getElementById("week").classList.add("hidden");
  document.getElementById("month").classList.add("hidden");
  document.getElementById("year").classList.add("hidden");
  document.getElementById(name).classList.remove("hidden");
};
</script>

</body>
</html>

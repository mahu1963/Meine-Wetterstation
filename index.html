<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wetterstation ‚Äì Martin Huber</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        background: #111;
        color: #fff;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
    }
    h2 {
        margin-top: 0;
    }
    #live, #openweather, #gps {
        margin-bottom: 15px;
        font-size: 1.1rem;
        line-height: 1.6;
    }
    #mainChart {
        width: 100%;
        height: 320px;
    }
    #rangeButtons button,
    #saveBtn {
        margin-right: 8px;
        margin-bottom: 8px;
        padding: 6px 12px;
        background: #222;
        color: #fff;
        border: 1px solid #444;
        cursor: pointer;
        border-radius: 4px;
    }
    #rangeButtons button:hover,
    #saveBtn:hover {
        background: #444;
    }
    #rangeButtons button.active {
        background: #666;
    }
</style>
</head>

<body>

<h2>üå¶Ô∏è Wetterstation ‚Äì Martin Huber</h2>

<div id="live">Live-Daten werden geladen‚Ä¶</div>
<div id="openweather">OpenWeather l√§dt‚Ä¶</div>
<div id="gps">GPS l√§dt‚Ä¶</div>

<div id="rangeButtons">
    <button id="btnWeek"  onclick="setRange('week')">Woche</button>
    <button id="btnMonth" onclick="setRange('month')">Monat</button>
    <button id="btnYear"  onclick="setRange('year')">Jahr</button>
    <button id="saveBtn"  onclick="saveChart()">Diagramm speichern</button>
</div>

<canvas id="mainChart"></canvas>

<script type="module">
/* ================= FIREBASE INITIALISIERUNG ================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAfIU041dyNBiCC_ywpJiwf8mABJVsT-lw",
  authDomain: "meine-wetterstation.firebaseapp.com",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "meine-wetterstation",
  storageBucket: "meine-wetterstation.appspot.com",
  messagingSenderId: "593494014586",
  appId: "1:593494014586:web:a05ed68495b1b16d6059c3",
  measurementId: "G-ST9RCRW888"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ================= HILFSFUNKTIONEN ================= */

let lastTemp = null;

function tempColor(t) {
    if (t <= -5) return "#4da3ff";
    if (t < 5)   return "#7fbfff";
    if (t < 15)  return "#a0ffb0";
    if (t < 25)  return "#ffe680";
    if (t < 30)  return "#ffb347";
    return "#ff5c5c";
}

function trendArrow(curr, prev) {
    if (prev === null || prev === undefined) return "‚óè";
    if (curr > prev) return "‚ñ≤";
    if (curr < prev) return "‚ñº";
    return "‚óè";
}

function trendColor(curr, prev) {
    if (prev === null || prev === undefined) return "#ccc";
    if (curr > prev) return "red";
    if (curr < prev) return "deepskyblue";
    return "#ccc";
}

/* ================= LIVE-DATEN AUS /weather ================= */

onValue(ref(db, "/weather/temperature"), (snap) => {
    const temp = snap.val();
    if (temp == null) return;

    const liveEl = document.getElementById("live");
    const arrow  = trendArrow(temp, lastTemp);
    const color  = trendColor(temp, lastTemp);
    lastTemp = temp;

    liveEl.style.color = tempColor(temp);
    liveEl.innerHTML = `üå°Ô∏è <span style="color:${color}">${arrow}</span> ${temp.toFixed(1)} ¬∞C`;
});

onValue(ref(db, "/weather/humidity"), (snap) => {
    const hum = snap.val();
    if (hum == null) return;

    const liveEl = document.getElementById("live");
    liveEl.innerHTML += `<br>üíß ${hum.toFixed(1)} %`;
});

onValue(ref(db, "/weather/pressure"), (snap) => {
    const pres = snap.val();
    if (pres == null) return;

    const liveEl = document.getElementById("live");
    liveEl.innerHTML += `<br>üß≠ ${pres.toFixed(1)} hPa`;
});

onValue(ref(db, "/weather/timestamp"), (snap) => {
    const t = snap.val();
    if (t == null) return;

    const dt = new Date(t * 1000).toLocaleString("de-AT");
    const liveEl = document.getElementById("live");
    liveEl.innerHTML += `<br>‚è±Ô∏è ${dt}`;
});

/* ================= OPENWEATHER ================= */

async function loadOpenWeather() {
    const apiKey = "27602f1bbb8e3dd3587a1da6e3de24b6";   // <-- DEIN KEY
    const lat = 47.366;
    const lon = 16.266;

    // Nur pr√ºfen, ob der Key leer oder zu kurz ist
    if (!apiKey || apiKey.length < 30) {
        document.getElementById("openweather").innerHTML = "27602f1bbb8e3dd3587a1da6e3de24b6";
        return;
    }

    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=de&appid=${apiKey}`;
        const res = await fetch(url);

        if (!res.ok) {
            document.getElementById("openweather").innerHTML = `OpenWeather Fehler: ${res.status}`;
            console.error("OpenWeather HTTP-Fehler:", res.status, await res.text());
            return;
        }

        const data = await res.json();

        const ow = document.getElementById("openweather");
        ow.innerHTML = `
            ‚òÅÔ∏è ${data.weather[0].description}<br>
            üå°Ô∏è ${data.main.temp.toFixed(1)} ¬∞C<br>
            üíß ${data.main.humidity}%<br>
            üå¨Ô∏è ${data.wind.speed} m/s
        `;
    } catch (err) {
        console.error("OpenWeather Fehler:", err);
        document.getElementById("openweather").innerHTML = "OpenWeather Fehler in der Abfrage.";
    }
}

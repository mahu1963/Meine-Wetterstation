<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meine Wetterstation</title>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(#b3e5ff, #e6f7ff);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        .werte {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* Glas-Effekt-Karten */
        .wert {
            flex: 1 1 150px;
            background: rgba(255,255,255,0.45);
            backdrop-filter: blur(6px);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.6rem;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            color: #222;
        }

        /* Farben */
        .tempColor { color: #ff3333; }

        .trend {
            font-size: 1.4rem;
            margin-left: 10px;
        }

        /* Glowbar */
        .glowbar {
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, #ff9999, #ff3333);
            background-size: 200% 100%;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        /* Charts */
        canvas {
            margin-top: 40px;
            background: rgba(255,255,255,0.45);
            backdrop-filter: blur(6px);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }

        /* Dropdown */
        #yearSelect {
            padding: 10px;
            font-size: 1.1rem;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<h1>Meine Wetterstation</h1>

<!-- Live-Werte -->
<div class="werte">
    <div class="wert">
        <div class="glowbar"></div>
        <i class="fa-solid fa-temperature-three-quarters tempColor"></i>
        <span id="temp" class="tempColor">–</span> °C
        <i id="tempTrend" class="trend tempColor"></i>
    </div>

    <div class="wert">
        <div class="glowbar"></div>
        <i class="fa-solid fa-arrow-up tempColor"></i>
        <span id="tempMax" class="tempColor">–</span> °C (Max)
    </div>

    <div class="wert">
        <div class="glowbar"></div>
        <i class="fa-solid fa-arrow-down tempColor"></i>
        <span id="tempMin" class="tempColor">–</span> °C (Min)
    </div>
</div>

<!-- Diagramme -->
<h2>Temperaturverlauf (24h)</h2>
<canvas id="tempChart"></canvas>

<h2>Feuchteverlauf (24h)</h2>
<canvas id="humDay"></canvas>

<h2>Druckverlauf (24h)</h2>
<canvas id="pressDay"></canvas>
    
    <h2>Temperatur – letzte 7 Tage</h2>
<canvas id="tempWeek"></canvas>

<h2>Temperatur – letzter Monat</h2>
<canvas id="tempMonth"></canvas>

<h2>Jahresdiagramm</h2>
<select id="yearSelect"></select>
<canvas id="yearChart"></canvas>

<script>
/* Firebase Config */
const firebaseConfig = {
    apiKey: "AIzaSyAfIU041dyNBiCC_ywpJiwf8mABJVsT-lw",
    authDomain: "meine-wetterstation.firebaseapp.com",
    databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "meine-wetterstation",
    storageBucket: "meine-wetterstation.firebasestorage.app",
    messagingSenderId: "593494014586",
    appId: "1:593494014586:web:a05ed68495b1b16d6059c3",
    measurementId: "G-ST9RCRW888"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* Trend */
function updateTrend(id, current, last) {
    const el = document.getElementById(id);
    if (last === null) return;

    if (current > last) el.className = "fa-solid fa-arrow-up trend tempColor";
    else if (current < last) el.className = "fa-solid fa-arrow-down trend tempColor";
    else el.className = "fa-solid fa-minus trend tempColor";
}

/* Live-Werte */
let lastTemp = null;

db.ref("weather/temperature").on("value", s => {
    const v = s.val();
    document.getElementById("temp").textContent = v.toFixed(1);
    updateTrend("tempTrend", v, lastTemp);
    lastTemp = v;
});

/* Charts */
function createChart(id, label, color) {
    return new Chart(document.getElementById(id).getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [{ label, data: [], borderColor: color, backgroundColor: color + "33", tension: 0.3 }] }
    });
}

const tempChart = createChart("tempChart", "Temperatur (°C)", "#ff3333");
const humDay = createChart("humDay", "Feuchte (%)", "#ff8800");
const pressDay = createChart("pressDay", "Druck (hPa)", "#0033cc");
const tempWeek = createChart("tempWeek", "Temperatur (°C)", "#ff3333");
const tempMonth = createChart("tempMonth", "Temperatur (°C)", "#ff3333");
    
    /* History */
const now = Math.floor(Date.now() / 1000);
const since24h = now - 86400;
const sinceWeek = now - 7 * 86400;
const sinceMonth = now - 30 * 86400;

let tempValues = [];

function addHistory(ref, chart, since, callback) {
    db.ref(ref).orderByKey().startAt(String(since)).on("child_added", snap => {
        const ts = snap.key;
        const val = snap.val();

        const time = new Date(ts * 1000).toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });

        chart.data.labels.push(time);
        chart.data.datasets[0].data.push(val);
        chart.update();

        if (callback) callback(val);
    });
}

/* Temperatur 24h */
addHistory("history/temperature", tempChart, since24h, val => {
    tempValues.push(val);
    document.getElementById("tempMax").textContent = Math.max(...tempValues).toFixed(1);
    document.getElementById("tempMin").textContent = Math.min(...tempValues).toFixed(1);
});

/* Woche & Monat */
addHistory("history/temperature", tempWeek, sinceWeek);
addHistory("history/temperature", tempMonth, sinceMonth);

/* Jahresdiagramm */
let yearChart = null;

function loadYears() {
    db.ref("history/year").once("value", snap => {
        const years = Object.keys(snap.val() || {});
        const select = document.getElementById("yearSelect");

        years.forEach(y => {
            const opt = document.createElement("option");
            opt.value = y;
            opt.textContent = y;
            select.appendChild(opt);
        });

        loadYearData(years[years.length - 1]); // letztes Jahr automatisch
    });
}

function loadYearData(year) {
    if (yearChart) yearChart.destroy();

    const monthsMin = Array(12).fill(null);
    const monthsMax = Array(12).fill(null);

    db.ref("history/year/" + year + "/temperature").once("value", snap => {
        snap.forEach(child => {
            const ts = Number(child.key);
            const val = child.val();
            const m = new Date(ts * 1000).getMonth();

            if (monthsMin[m] === null || val < monthsMin[m]) monthsMin[m] = val;
            if (monthsMax[m] === null || val > monthsMax[m]) monthsMax[m] = val;
        });

        const ctx = document.getElementById("yearChart").getContext("2d");

        yearChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: ["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],
                datasets: [
                    {
                        label: "Min",
                        data: monthsMin,
                        backgroundColor: "#99ccff",
                        borderColor: "#3399ff",
                        borderWidth: 1
                    },
                    {
                        label: "Max",
                        data: monthsMax,
                        type: "line",
                        borderColor: "#ff3333",
                        borderWidth: 3,
                        fill: false,
                        tension: 0.3
                    }
                ]
            }
        });
    });
}

document.getElementById("yearSelect").addEventListener("change", e => {
    loadYearData(e.target.value);
});

loadYears();
</script>

</body>
</html>    


<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wetterstation ‚Äì Martin Huber</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        background: #111;
        color: #fff;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
    }
    h2 {
        margin-top: 0;
    }
    #live, #openweather, #gps {
        margin-bottom: 15px;
        font-size: 1.1rem;
        line-height: 1.6;
    }
    #mainChart {
        width: 100%;
        height: 320px;
    }
    #rangeButtons button,
    #saveBtn {
        margin-right: 8px;
        margin-bottom: 8px;
        padding: 6px 12px;
        background: #222;
        color: #fff;
        border: 1px solid #444;
        cursor: pointer;
        border-radius: 4px;
    }
    #rangeButtons button:hover,
    #saveBtn:hover {
        background: #444;
    }
    #rangeButtons button.active {
        background: #666;
    }
</style>
</head>

<body>

<h2>üå¶Ô∏è Wetterstation ‚Äì Martin Huber</h2>

<div id="live">Live-Daten werden geladen‚Ä¶</div>
<div id="openweather">OpenWeather l√§dt‚Ä¶</div>
<div id="gps">GPS l√§dt‚Ä¶</div>

<div id="rangeButtons">
    <button id="btnWeek"  onclick="setRange('week')">Woche</button>
    <button id="btnMonth" onclick="setRange('month')">Monat</button>
    <button id="btnYear"  onclick="setRange('year')">Jahr</button>
    <button id="saveBtn"  onclick="saveChart()">Diagramm speichern</button>
</div>

<canvas id="mainChart"></canvas>

<script type="module">
/* ================= FIREBASE INITIALISIERUNG ================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAfIU041dyNBiCC_ywpJiwf8mABJVsT-lw",
  authDomain: "meine-wetterstation.firebaseapp.com",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "meine-wetterstation",
  storageBucket: "meine-wetterstation.appspot.com",
  messagingSenderId: "593494014586",
  appId: "1:593494014586:web:a05ed68495b1b16d6059c3",
  measurementId: "G-ST9RCRW888"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ================= HILFSFUNKTIONEN ================= */

let lastTemp = null;

function tempColor(t) {
    if (t <= -5) return "#4da3ff";
    if (t < 5)   return "#7fbfff";
    if (t < 15)  return "#a0ffb0";
    if (t < 25)  return "#ffe680";
    if (t < 30)  return "#ffb347";
    return "#ff5c5c";
}

function trendArrow(curr, prev) {
    if (prev === null || prev === undefined) return "‚óè";
    if (curr > prev) return "‚ñ≤";
    if (curr < prev) return "‚ñº";
    return "‚óè";
}

function trendColor(curr, prev) {
    if (prev === null || prev === undefined) return "#ccc";
    if (curr > prev) return "red";
    if (curr < prev) return "deepskyblue";
    return "#ccc";
}

/* ================= LIVE-DATEN AUS /weather ================= */

onValue(ref(db, "/weather/temperature"), (snap) => {
    const temp = snap.val();
    if (temp == null) return;

    const liveEl = document.getElementById("live");
    const arrow  = trendArrow(temp, lastTemp);
    const color  = trendColor(temp, lastTemp);
    lastTemp = temp;

    liveEl.style.color = tempColor(temp);
    liveEl.innerHTML = `üå°Ô∏è <span style="color:${color}">${arrow}</span> ${temp.toFixed(1)} ¬∞C`;
});

onValue(ref(db, "/weather/humidity"), (snap) => {
    const hum = snap.val();
    if (hum == null) return;

    const liveEl = document.getElementById("live");
    liveEl.innerHTML += `<br>üíß ${hum.toFixed(1)} %`;
});

onValue(ref(db, "/weather/pressure"), (snap) => {
    const pres = snap.val();
    if (pres == null) return;

    const liveEl = document.getElementById("live");
    liveEl.innerHTML += `<br>üß≠ ${pres.toFixed(1)} hPa`;
});

onValue(ref(db, "/weather/timestamp"), (snap) => {
    const t = snap.val();
    if (t == null) return;

    const dt = new Date(t * 1000).toLocaleString("de-AT");
    const liveEl = document.getElementById("live");
    liveEl.innerHTML += `<br>‚è±Ô∏è ${dt}`;
});

/* ================= OPENWEATHER ================= */

async function loadOpenWeather() {
    const apiKey = "DEIN_OPENWEATHER_API_KEY";   // <-- HIER EINTRAGEN
    const lat = 47.366;
    const lon = 16.266;

    if (!apiKey || apiKey === "27602f1bbb8e3dd3587a1da6e3de24b6") {
        document.getElementById("openweather").innerHTML = "Bitte OpenWeather API-Key eintragen.";
        return;
    }

    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=de&appid=${apiKey}`;
        const res = await fetch(url);
        const data = await res.json();

        const ow = document.getElementById("openweather");
        ow.innerHTML = `
            ‚òÅÔ∏è ${data.weather[0].description}<br>
            üå°Ô∏è ${data.main.temp.toFixed(1)} ¬∞C<br>
            üíß ${data.main.humidity}%<br>
            üå¨Ô∏è ${data.wind.speed} m/s
        `;
    } catch (err) {
        console.error("OpenWeather Fehler:", err);
        document.getElementById("openweather").innerHTML = "OpenWeather Fehler in der Abfrage.";
    }
}

/* ================= GPS ================= */

function loadGPS() {
    if (!navigator.geolocation) {
        document.getElementById("gps").innerHTML = "‚ùå GPS nicht verf√ºgbar";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude.toFixed(5);
            const lon = pos.coords.longitude.toFixed(5);
            document.getElementById("gps").innerHTML = `üìç ${lat}, ${lon}`;
        },
        (err) => {
            document.getElementById("gps").innerHTML = "‚ùå GPS blockiert";
            console.warn("GPS Fehler:", err);
        }
    );
}

/* ================= CHART MIT 3 DATENS√ÑTZEN ================= */

const ctx = document.getElementById("mainChart").getContext("2d");
let mainChart = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [
            {
                label: "Temperatur (¬∞C)",
                data: [],
                borderColor: "#ffb347",
                backgroundColor: "rgba(255,179,71,0.2)",
                tension: 0.2,
                pointRadius: 0
            },
            {
                label: "Luftfeuchtigkeit (%)",
                data: [],
                borderColor: "#4da3ff",
                backgroundColor: "rgba(77,163,255,0.2)",
                tension: 0.2,
                pointRadius: 0
            },
            {
                label: "Luftdruck (hPa)",
                data: [],
                borderColor: "#a0ffb0",
                backgroundColor: "rgba(160,255,176,0.2)",
                tension: 0.2,
                pointRadius: 0,
                yAxisID: "y2"
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { ticks: { color: "#ccc" }, grid: { color: "#333" } },
            y: { 
                ticks: { color: "#ccc" }, 
                grid: { color: "#333" },
                position: "left"
            },
            y2: {
                ticks: { color: "#ccc" },
                grid: { display: false },
                position: "right"
            }
        },
        plugins: {
            legend: { labels: { color: "#fff" } }
        }
    }
});

/* ================= WOCHE / MONAT / JAHR ================= */

let historyRange = "week";

function setRange(r) {
    historyRange = r;
    document.getElementById("btnWeek").classList.remove("active");
    document.getElementById("btnMonth").classList.remove("active");
    document.getElementById("btnYear").classList.remove("active");

    if (r === "week")  document.getElementById("btnWeek").classList.add("active");
    if (r === "month") document.getElementById("btnMonth").classList.add("active");
    if (r === "year")  document.getElementById("btnYear").classList.add("active");

    loadHistory();
}
window.setRange = setRange; // f√ºr Buttons

/* ================= HISTORY AUS /weather/history ================= */

let tempData = {};
let humData  = {};
let presData = {};

function loadHistory() {
    const baseTemp = `/weather/history/temperature`;
    const baseHum  = `/weather/history/humidity`;
    const basePres = `/weather/history/pressure`;

    function updateChart() {
        const nowSec = Date.now() / 1000;
        let limit = nowSec - 7 * 24 * 3600; // Woche

        if (historyRange === "month") limit = nowSec - 30 * 24 * 3600;
        if (historyRange === "year")  limit = nowSec - 365 * 24 * 3600;

        const timestamps = Object.keys(tempData || {})
            .map(t => parseInt(t))
            .filter(t => t >= limit)
            .sort((a, b) => a - b);

        const labels = [];
        const temps  = [];
        const hums   = [];
        const press  = [];

        timestamps.forEach(ts => {
            const date = new Date(ts * 1000);
            labels.push(date.toLocaleString("de-AT", { hour: "2-digit", minute: "2-digit", day: "2-digit", month: "2-digit" }));

            temps.push(tempData[ts] ?? null);
            hums.push(humData[ts] ?? null);
            press.push(presData[ts] ?? null);
        });

        mainChart.data.labels = labels;
        mainChart.data.datasets[0].data = temps;
        mainChart.data.datasets[1].data = hums;
        mainChart.data.datasets[2].data = press;

        mainChart.update();
    }

    onValue(ref(db, baseTemp), (snap) => {
        tempData = snap.val() || {};
        updateChart();
    });

    onValue(ref(db, baseHum), (snap) => {
        humData = snap.val() || {};
        updateChart();
    });

    onValue(ref(db, basePres), (snap) => {
        presData = snap.val() || {};
        updateChart();
    });
}

/* ================= DIAGRAMM SPEICHERN ================= */

function saveChart() {
    const link = document.createElement('a');
    link.download = "wetterstation-diagramm.png";
    link.href = mainChart.toBase64Image();
    link.click();
}
window.saveChart = saveChart;

/* ================= INIT ================= */

loadOpenWeather();
loadGPS();
setRange("week"); // setzt auch Buttons & l√§dt History

</script>

</body>
</html>

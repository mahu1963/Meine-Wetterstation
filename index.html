<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Wetterstation Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        background: #121212;
        color: #eee;
        font-family: Arial, sans-serif;
    }

    h1 {
        text-align: center;
        padding: 20px;
        margin: 0;
        font-size: 32px;
        color: #fff;
    }

    /* LIVE-WERTE */
    .cards {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px;
        flex-wrap: wrap;
    }

    .card {
        background: #1e1e1e;
        padding: 20px;
        border-radius: 12px;
        width: 200px;
        text-align: center;
        box-shadow: 0 0 10px #000;
    }

    .value {
        font-size: 32px;
        margin-top: 10px;
        color: #4fc3f7;
    }

    /* BUTTONS */
    .buttons {
        text-align: center;
        margin-bottom: 20px;
    }

    button {
        background: #333;
        color: #fff;
        border: none;
        padding: 12px 20px;
        margin: 5px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
    }

    button.active {
        background: #4fc3f7;
        color: #000;
    }

    /* DIAGRAMM-TABS */
    .chart-tabs {
        text-align: center;
        margin-bottom: 10px;
    }

    .chart-tab {
        background: #222;
        padding: 10px 15px;
        margin: 5px;
        border-radius: 6px;
        cursor: pointer;
        display: inline-block;
    }

    .chart-tab.active {
        background: #4fc3f7;
        color: #000;
    }

    /* CHART */
    #chart-container {
        width: 95%;
        margin: auto;
        padding-bottom: 40px;
    }

    /* MIN/MAX */
    .minmax {
        text-align: center;
        margin-top: 10px;
        font-size: 18px;
        color: #bbb;
    }

    /* RESPONSIVE */
    @media (max-width: 600px) {
        .card {
            width: 140px;
            padding: 15px;
        }
        .value {
            font-size: 26px;
        }
        button {
            padding: 10px 14px;
            font-size: 14px;
        }
    }
</style>
</head>

<body>

<h1>Wetterstation Dashboard</h1>

<!-- LIVE-WERTE -->
<div class="cards">
    <div class="card">
        ðŸŒ¡ Temperatur
        <div class="value" id="temp">--</div>
    </div>
    <div class="card">
        ðŸ’§ Feuchte
        <div class="value" id="hum">--</div>
    </div>
    <div class="card">
        ðŸŒ¬ Druck
        <div class="value" id="pres">--</div>
    </div>
</div>

<!-- ZEITRAUM-BUTTONS -->
<div class="buttons">
    <button onclick="setMode('today')" id="btn-today">Heute</button>
    <button onclick="setMode('week')" id="btn-week">Woche</button>
    <button onclick="setMode('month')" id="btn-month">Monat</button>
    <button onclick="setMode('year')" id="btn-year">Jahr</button>
</div>

<!-- DIAGRAMM-TABS -->
<div class="chart-tabs">
    <span class="chart-tab active" id="tab-temp" onclick="setChartType('temp')">Temperatur</span>
    <span class="chart-tab" id="tab-hum" onclick="setChartType('hum')">Feuchte</span>
    <span class="chart-tab" id="tab-pres" onclick="setChartType('pres')">Druck</span>
</div>

<!-- MIN/MAX -->
<div class="minmax" id="minmax">Min/Max wird geladenâ€¦</div>

<!-- CHART -->
<div id="chart-container">
    <canvas id="chart"></canvas>
</div>

<script>
// ------------------------------------------------------------
// Firebase KONFIGURATION â€” HIER EINTRAGEN
// ------------------------------------------------------------
const firebaseConfig = {
    apiKey: "DEIN_API_KEY",
    authDomain: "DEINE_DOMAIN",
    databaseURL: "DEINE_DATABASE_URL",
    projectId: "DEIN_PROJECT_ID",
    storageBucket: "DEIN_BUCKET",
    messagingSenderId: "DEINE_SENDER_ID",
    appId: "DEINE_APP_ID"
};

firebase.initializeApp(firebaseConfig);

// ------------------------------------------------------------
// LIVE-WERTE
// ------------------------------------------------------------
firebase.database().ref("weather").on("value", snap => {
    const d = snap.val();
    if (!d) return;

    document.getElementById("temp").innerText = d.temperature.toFixed(1);
    document.getElementById("hum").innerText  = d.humidity.toFixed(1);
    document.getElementById("pres").innerText = d.pressure.toFixed(1);
});

// ------------------------------------------------------------
// HISTORY LADEN
// ------------------------------------------------------------
function loadHistoryPath(path, callback) {
    firebase.database().ref(path).once("value", snapshot => {
        const data = snapshot.val();
        if (!data) {
            callback([], [], [], []);
            return;
        }

        const times = [];
        const temps = [];
        const hums = [];
        const press = [];

        const keys = Object.keys(data).sort();

        keys.forEach(key => {
            const entry = data[key];
            if (!entry) return;

            times.push(key);
            temps.push(entry.temperature);
            hums.push(entry.humidity);
            press.push(entry.pressure);
        });

        callback(times, temps, hums, press);
    });
}

// ------------------------------------------------------------
// CHART
// ------------------------------------------------------------
let chart;
let chartType = "temp";

function setChartType(type) {
    chartType = type;

    document.querySelectorAll(".chart-tab").forEach(t => t.classList.remove("active"));
    document.getElementById(`tab-${type}`).classList.add("active");

    loadMode();
}

function updateChart(times, temps, hums, press) {
    const ctx = document.getElementById("chart").getContext("2d");

    if (chart) chart.destroy();

    let dataset;
    let color;

    if (chartType === "temp") {
        dataset = temps;
        color = "#ff9800";
    } else if (chartType === "hum") {
        dataset = hums;
        color = "#4fc3f7";
    } else {
        dataset = press;
        color = "#81c784";
    }

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: times,
            datasets: [
                {
                    label: chartType === "temp" ? "Temperatur (Â°C)" :
                           chartType === "hum"  ? "Feuchte (%)" :
                                                  "Druck (hPa)",
                    data: dataset,
                    borderColor: color,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            animation: false
        }
    });

    updateMinMax(temps, hums, press);
}

// ------------------------------------------------------------
// MIN/MAX
// ------------------------------------------------------------
function updateMinMax(temps, hums, press) {
    if (temps.length === 0) {
        document.getElementById("minmax").innerText = "Keine Daten";
        return;
    }

    const tMin = Math.min(...temps).toFixed(1);
    const tMax = Math.max(...temps).toFixed(1);

    const hMin = Math.min(...hums).toFixed(1);
    const hMax = Math.max(...hums).toFixed(1);

    const pMin = Math.min(...press).toFixed(1);
    const pMax = Math.max(...press).toFixed(1);

    document.getElementById("minmax").innerText =
        `Temp: ${tMin}Â°C â€“ ${tMax}Â°C | Feuchte: ${hMin}% â€“ ${hMax}% | Druck: ${pMin} â€“ ${pMax} hPa`;
}

// ------------------------------------------------------------
// ZEITRÃ„UME
// ------------------------------------------------------------
function loadTodayHistory() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");

    loadHistoryPath(`history/${y}/${m}/${d}`, updateChart);
}

function loadRange(daysBack, callback) {
    const now = new Date();
    const promises = [];

    for (let i = 0; i < daysBack; i++) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);

        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");

        const path = `history/${y}/${m}/${da}`;

        promises.push(
            new Promise(resolve => {
                loadHistoryPath(path, (t, te, h, p) => resolve({ t, te, h, p }));
            })
        );
    }

    Promise.all(promises).then(days => {
        const times = [], temps = [], hums = [], press = [];

        days.reverse().forEach(day => {
            day.t.forEach((time, i) => {
                times.push(time);
                temps.push(day.te[i]);
                hums.push(day.h[i]);
                press.push(day.p[i]);
            });
        });

        callback(times, temps, hums, press);
    });
}

function loadWeekHistory()  { loadRange(7,  updateChart); }
function loadMonthHistory() { loadRange(30, updateChart); }
function loadYearHistory()  { loadRange(365, updateChart); }

// ------------------------------------------------------------
// BUTTON-AKTIVIERUNG + AUTO-REFRESH
// ------------------------------------------------------------
let currentMode = "today";
let refreshTimer;

function setMode(mode) {
    currentMode = mode;

    document.querySelectorAll("button").forEach(btn => btn.classList.remove("active"));
    document.getElementById(`btn-${mode}`).classList.add("active");

    loadMode();
}

function loadMode() {
    if (refreshTimer) clearInterval(refreshTimer);

    if (currentMode === "today") loadTodayHistory();
    if (currentMode === "week")  loadWeekHistory();
    if (currentMode === "month") loadMonthHistory();
    if (currentMode === "year")  loadYearHistory();

    refreshTimer = setInterval(loadMode, 60000);
}

// ------------------------------------------------------------
// START
// ------------------------------------------------------------
setMode("today");

</script>
</body>
</html>

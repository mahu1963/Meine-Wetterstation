<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Wetterstation Dashboard</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Wetterstation">
<link rel="apple-touch-icon" href="icon.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root {
  --bg: #0d0d0d;
  --fg: #f5f5f5;
  --card: #1a1a1a;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, Arial;
  background: var(--bg);
  color: var(--fg);
  padding: 20px;
}

#container {
  max-width: 480px;
  margin: 0 auto;
}

/* Topbar */
#topbar {
  width: 100%;
  background: #111;
  padding: 12px;
  border-radius: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

#top-left {
  font-size: 16px;
  line-height: 1.2;
}

#top-right {
  font-size: 40px;
}

/* Charts */
canvas {
  max-width: 100%;
  width: 100%;
  min-height: 260px !important;
  background: var(--card);
  padding: 10px;
  border-radius: 12px;
}

button {
  padding: 8px 14px;
  margin-right: 6px;
  cursor: pointer;
  background: #222;
  color: var(--fg);
  border: 1px solid #444;
  border-radius: 6px;
}

.hidden { display: none; }

/* Live */
#livebox {
  display: flex;
  align-items: center;
  font-size: 22px;
  margin-bottom: 10px;
}

#live-icon {
  font-size: 32px;
  margin-right: 12px;
  animation: pulse 1.2s infinite;
}

@keyframes pulse {
  0% { opacity: 0.4; }
  50% { opacity: 1; }
  100% { opacity: 0.4; }
}

/* Forecast */
#forecast-box {
  background: var(--card);
  padding: 10px;
  border-radius: 12px;
  margin-top: 20px;
}

/* Radar */
#radar {
  width: 100%;
  height: 400px;
  border-radius: 12px;
  margin-top: 20px;
  background: var(--card);
}

/* Neon Wetterbox */
@keyframes fadeIn {
  from { opacity:0; transform: translateY(10px); }
  to   { opacity:1; transform: translateY(0); }
}

@keyframes neonPulse {
  0%   { box-shadow: 0 0 10px rgba(0,255,255,0.4); }
  50%  { box-shadow: 0 0 20px rgba(0,255,255,0.8); }
  100% { box-shadow: 0 0 10px rgba(0,255,255,0.4); }
}

.neon-glow {
  animation: neonPulse 2.5s infinite ease-in-out;
}

.rotate {
  transition: transform 0.6s ease;
}
</style>
</head>

<body>
<div id="container">

<h1 style="text-align:center;">üå§ Wetterstation</h1>
<div style="text-align:center; font-size:12px; opacity:20.0; margin-top:-8px;">
  von Martin Huber
</div>

<div id="topbar">
  <div id="top-left">
    <div id="sunrise">üåÖ --:--</div>
    <div id="sunset">üåá --:--</div>
  </div>
  <div id="top-right">
    <span id="top-weather-icon">‚òÄÔ∏è</span>
  </div>
</div>

<h2 id="livebox">
  <span id="live-icon">‚ùì</span>
  Aktuelle Messwerte
</h2>

<div id="livevalues">
  <p id="live-temp"></p>
  <p id="live-hum"></p>
  <p id="live-press"></p>
  <p id="live-time"></p>
  <p id="live-trend"></p>
  <p id="minmax"></p>
</div>

<div class="tab">
  <button onclick="showTab('24h')">24h</button>
  <button onclick="showTab('week')">Woche</button>
  <button onclick="showTab('month')">Monat</button>
  <button onclick="showTab('year')">Jahr</button>
</div>

<div id="24h"><canvas id="chart24h"></canvas></div>
<div id="week" class="hidden"><canvas id="chartWeek"></canvas></div>
<div id="month" class="hidden"><canvas id="chartMonth"></canvas></div>
<div id="year" class="hidden"><canvas id="chartYear"></canvas></div>

<h2>Interaktives Regenradar</h2>
<div id="radar"></div>

<!-- ‚≠ê NEON WETTERBOX -->
<div id="currentWeatherBox" 
     style="
       margin-top:20px;
       padding:20px;
       background:rgba(0,0,0,0.25);
       border-radius:15px;
       color:white;
       font-size:18px;
       backdrop-filter: blur(8px);
       border: 1px solid rgba(0,255,255,0.4);
       box-shadow: 0 0 15px rgba(0,255,255,0.4);
       animation: fadeIn 0.8s ease-out;
     ">
  Wetter wird geladen...
</div>

<div id="forecast-box">
  <h2>OpenWeather Vorhersage (5 Tage)</h2>
  <div id="forecast"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "XXX",
  authDomain: "meine-wetterstation.firebaseapp.com",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "meine-wetterstation",
  storageBucket: "meine-wetterstation.firebasestorage.app",
  messagingSenderId: "593494014586",
  appId: "1:593494014586:web:a05ed68495b1b16d6059c3",
  measurementId: "G-ST9RCRW888"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Live-Werte */
const liveRef = ref(db, "weather/live");
let lastTemp = null;

onValue(liveRef, (snap) => {
  const d = snap.val();
  if (!d) return;

  const t = d.temperature;

  document.getElementById("live-temp").textContent =
    "üå° Temperatur: " + t.toFixed(1) + " ¬∞C";

  document.getElementById("live-hum").textContent =
    "üíß Luftfeuchtigkeit: " + d.humidity.toFixed(1) + " %";

  document.getElementById("live-press").textContent =
    "üåç Luftdruck: " + d.pressure.toFixed(1) + " hPa";

  if (d.timestamp) {
    const lt = new Date(d.timestamp * 1000)
      .toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });
    document.getElementById("live-time").textContent =
      "‚è± Aktualisiert: " + lt;
  }

  if (lastTemp !== null) {
    if (t > lastTemp) document.getElementById("live-trend").textContent = "üìà Temperatur steigt";
    else if (t < lastTemp) document.getElementById("live-trend").textContent = "üìâ Temperatur f√§llt";
    else document.getElementById("live-trend").textContent = "‚û°Ô∏è stabil";
  }
  lastTemp = t;

  if (d.openweather && d.openweather.weather && d.openweather.weather[0]) {
    const ow = d.openweather;
    const w = ow.weather[0].main.toLowerCase();

    let icon = "‚ùì";
    if (w.includes("clear")) icon = "‚òÄÔ∏è";
    else if (w.includes("cloud")) icon = "‚òÅÔ∏è";
    else if (w.includes("rain")) icon = "üåßÔ∏è";
    else if (w.includes("snow")) icon = "‚ùÑÔ∏è";

    document.getElementById("live-icon").textContent = icon;
    document.getElementById("top-weather-icon").textContent = icon;

    if (ow.sys && ow.sys.sunrise && ow.sys.sunset && ow.timezone !== undefined) {
      const sr = new Date((ow.sys.sunrise + ow.timezone) * 1000)
        .toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });

      const ss = new Date((ow.sys.sunset + ow.timezone) * 1000)
        .toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });
      document.getElementById("sunrise").textContent = "üåÖ " + sr;
      document.getElementById("sunset").textContent = "üåá " + ss;
    }
  }
});

/* Min/Max */
async function updateMinMax() {
  const snap = await get(ref(db, "weather/history/24h"));
  const data = snap.val();
  if (!data) return;

  const temps = Object.values(data).map(v => v.t);
  const min = Math.min(...temps).toFixed(1);
  const max = Math.max(...temps).toFixed(1);

  document.getElementById("minmax").textContent =
    "Min/Max (24h): " + min + "¬∞C / " + max + "¬∞C";
}

setInterval(updateMinMax, 60000);
updateMinMax();

/* HISTORY LADEN */
async function loadHistory(path) {
  const snap = await get(ref(db, path));
  const data = snap.val();
  if (!data) return { labels: [], temps: [], hums: [], press: [] };

  const labels = [];
  const temps = [];
  const hums = [];
  const press = [];

  const timestamps = Object.keys(data).sort((a, b) => Number(a) - Number(b));

  for (const ts of timestamps) {
    const d = new Date(ts * 1000);

    let label = "";

    if (path.includes("24h")) {
      label = d.toLocaleTimeString("de-DE", {
        hour: "2-digit",
        minute: "2-digit"
      });
    } 
    else if (path.includes("week")) {
      label = d.toLocaleDateString("de-DE", {
        weekday: "short"
      }).replace(".", "");
    } 
    else if (path.includes("month")) {
      label = d.toLocaleDateString("de-DE", {
        month: "short"
      }).replace(".", "");
    } 
    else if (path.includes("year")) {
      label = d.toLocaleDateString("de-DE", {
        year: "numeric"
      });
    }

    labels.push(label);
    temps.push(data[ts].t);
    hums.push(data[ts].h);
    press.push(data[ts].p);
  }

  return { labels, temps, hums, press };
}

/* CHARTS */
async function drawChart(canvasId, path, title) {
  const ctx = document.getElementById(canvasId).getContext("2d");
  const { labels, temps, hums, press } = await loadHistory(path);

  new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        { 
          label: "Temperatur (¬∞C)", 
          data: temps, 
          borderColor: "rgba(255, 99, 99, 1)",
          backgroundColor: "rgba(255, 99, 99, 0.15)",
          borderWidth: 1.5,
          tension: 0.35,
          pointRadius: 0,
          fill: true,
          yAxisID: "y"
        },
        { 
          label: "Luftfeuchtigkeit (%)", 
          data: hums, 
          borderColor: "rgba(80, 160, 255, 1)",
          backgroundColor: "rgba(80, 160, 255, 0.15)",
          borderWidth: 1.5,
          tension: 0.35,
          pointRadius: 0,
          fill: true,
          yAxisID: "y1"
        },
        { 
          label: "Luftdruck (hPa)", 
          data: press, 
          borderColor: "rgba(120, 255, 120, 1)",
          backgroundColor: "rgba(120, 255, 120, 0.15)",
          borderWidth: 1.5,
          tension: 0.35,
          pointRadius: 0,
          fill: true,
          yAxisID: "y2"
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { 
        title: { 
          display: true, 
          text: title, 
          color: "#fff" 
        } 
      },
      scales: {
        y: { ticks: { color: "#ccc" } },
        y1: { ticks: { color: "#ccc" } },
        y2: { ticks: { color: "#ccc" } },
        x: { ticks: { color: "#ccc" } }
      }
    }
  });
}

/* FORECAST */
async function loadForecast() {
  const lat = 47.43599;
  const lon = 16.25597;
  const key = "27602f1bbb8e3dd3587a1da6e3de24b6";

  const url =
    `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=de&appid=${key}`;

  const res = await fetch(url);
  const data = await res.json();

  const box = document.getElementById("forecast");
  box.innerHTML = "";

  data.list.slice(0, 10).forEach(item => {
    const d = new Date((item.dt + data.city.timezone) * 1000);

    const textTime = d.toLocaleString("de-DE");

    const div = document.createElement("div");
    div.innerHTML =
      `<b>${textTime}</b><br>
       üå° ${item.main.temp.toFixed(1)}¬∞C<br>
       üå¶ ${item.weather[0].description}<br><br>`;
    box.appendChild(div);
  });
}

/* RADAR */
function initRadar() {
  const map = L.map('radar').setView([47.43599, 16.25597], 8);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  L.marker([47.43599, 16.25597]).addTo(map)
    .bindPopup("Mein Standort")
    .openPopup();

  const owmKey = "27602f1bbb8e3dd3587a1da6e3de24b6";

  L.tileLayer(
    `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${owmKey}`,
    { opacity: 0.6 }
  ).addTo(map);
}

/* ‚≠ê NEON WETTERBOX */
async function loadCurrentWeather() {
  const url = `https://api.openweathermap.org/data/2.5/weather?lat=47.43599&lon=16.25597&units=metric&lang=de&appid=27602f1bbb8e3dd3587a1da6e3de24b6`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    const icon = data.weather[0].icon;
    const temp = Math.round(data.main.temp);
    const desc = data.weather[0].description;

    const hum = data.main.humidity;
    const wind = data.wind.speed;
    const windDeg = data.wind.deg;
    const press = data.main.pressure;

    const windArrow = `
      <span style="display:inline-block; transform: rotate(${windDeg}deg); font-size:22px; margin-right:6px;">
        ‚û§
      </span>
      <span>${wind} m/s</span>
    `;

    document.getElementById("currentWeatherBox").innerHTML = `
      <div style="display:flex; align-items:center; gap:20px;" class="neon-glow">

        <img src="https://openweathermap.org/img/wn/${icon}@2x.png"
             style="width:90px; height:90px; animation: fadeIn 1s ease; filter: drop-shadow(0 0 8px #00ffff);">

        <div>
          <div style="font-size:32px; font-weight:bold; color:#00ffff; text-shadow:0 0 8px #00ffff;">
            ${temp}¬∞C
          </div>

          <div style="font-size:20px; margin-bottom:8px; text-shadow:0 0 6px #00ffff;">
            ${desc}
          </div>

          <div style="font-size:16px; line-height:1.4;">
            <b style="color:#00ffff;">Wind:</b> ${windArrow}<br>
            <b style="color:#00ffff;">Feuchtigkeit:</b> ${hum}%<br>
            <b style="color:#00ffff;">Luftdruck:</b> ${press} hPa<br>
            <b style="color:#00ffff;">Sonnenaufgang:</b> ${new Date((data.sys.sunrise + data.timezone) * 1000).toLocaleTimeString("de-DE", {hour:"2-digit", minute:"2-digit"})}<br>
            <b style="color:#00ffff;">Sonnenuntergang:</b> ${new Date((data.sys.sunset + data.timezone) * 1000).toLocaleTimeString("de-DE", {hour:"2-digit", minute:"2-digit"})}
          </div>
        </div>
      </div>
    `;
  } catch (e) {
    document.getElementById("currentWeatherBox").innerHTML =
      "Fehler beim Laden des Wetters";
  }
}

loadCurrentWeather();
setInterval(loadCurrentWeather, 600000);

/* TABS */
window.showTab = function(name) {
  document.getElementById("24h").classList.add("hidden");
  document.getElementById("week").classList.add("hidden");
  document.getElementById("month").classList.add("hidden");
  document.getElementById("year").classList.add("hidden");

  const tab = document.getElementById(name);
  tab.classList.remove("hidden");

  if (name === "24h") drawChart("chart24h", "weather/history/24h", "Letzte 24 Stunden");
  if (name === "week") drawChart("chartWeek", "weather/history/week", "Letzte 7 Tage");
  if (name === "month") drawChart("chartMonth", "weather/history/month", "Letzter Monat");
  if (name === "year") drawChart("chartYear", "weather/history/year", "Letztes Jahr");
};

/* START */
window.onload = () => {
  drawChart("chart24h", "weather/history/24h", "Letzte 24 Stunden");
  drawChart("chartWeek", "weather/history/week", "Letzte 7 Tage");
  drawChart("chartMonth", "weather/history/month", "Letzter Monat");
  drawChart("chartYear", "weather/history/year", "Letztes Jahr");
  initRadar();
  loadForecast();
};
</script>

</body>
</html>








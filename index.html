<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Wetterstation Stuben‑Bernstein</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin: 0;
    padding: 0;
    background: #0d0d0d;
    color: white;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
    font-size: 20px; /* größere Schrift */
}

.main {
    padding: 30px 20px 40px;
    max-width: 1100px;
    margin: 0 auto;
}

/* Header */
#header {
    text-align: center;
    margin-bottom: 30px;
}

#header h1 {
    margin: 10px 0 0;
    font-size: 34px;
}

#header h3 {
    margin: 5px 0 10px;
    font-weight: 400;
    opacity: 0.8;
}

#gps, #sunrise, #sunset {
    opacity: 0.8;
    font-size: 18px;
    margin-top: 4px;
}

/* Tabs untereinander */
.tabs {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    margin: 25px 0 10px;
}

.tab {
    padding: 16px 24px;
    border-radius: 14px;
    cursor: pointer;
    background: #1c1c1e;
    opacity: 0.7;
    transition: 0.2s;
    width: 90%;
    text-align: center;
    font-size: 22px;
}

.tab.active {
    background: #333;
    opacity: 1;
    font-weight: 600;
}

/* Sensor Buttons */
.sensor-buttons {
    display: flex;
    justify-content: center;
    gap: 18px;
    margin-bottom: 20px;
}

.sensor-btn {
    padding: 14px 22px;
    border-radius: 12px;
    background: #1c1c1e;
    cursor: pointer;
    opacity: 0.7;
    transition: 0.2s;
    font-size: 20px;
}

.sensor-btn.active {
    opacity: 1;
    font-weight: 600;
}

/* Chart Container */
.chart-box {
    background: #1c1c1e;
    padding: 20px;
    border-radius: 18px;
    margin-bottom: 30px;
}

#mainChart {
    height: 520px !important; /* großer Chart */
}

/* Radar */
#radar {
    background: #1c1c1e;
    padding: 20px;
    border-radius: 18px;
    margin-bottom: 30px;
}

#radar-frame {
    width: 100%;
    height: 260px;
    border: none;
    border-radius: 12px;
}
</style>
</head>
<body>

<div class="main">

    <div id="header">
        <img id="weather-icon" src="" style="width:140px;height:140px;">
        <h1>Stuben‑Bernstein</h1>
        <h3>Martin Huber</h3>

        <div id="gps">GPS lädt…</div>
        <div id="sunrise"></div>
        <div id="sunset"></div>
    </div>

    <!-- Regenradar -->
    <div id="radar">
        <iframe
            id="radar-frame"
            src="https://www.rainviewer.com/map.html?loc=47.366,16.233,9&oFa=1&oC=1&oU=1&oCS=1&oF=1&oAP=1&c=3&o=83&lm=1&layer=radar&sm=1&sn=1"
            loading="lazy">
        </iframe>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-range="today">Heute</div>
        <div class="tab" data-range="week">Woche</div>
        <div class="tab" data-range="month">Monat</div>
        <div class="tab" data-range="year">Jahr</div>
    </div>

    <!-- Sensor Buttons -->
    <div class="sensor-buttons">
        <div class="sensor-btn active" data-sensor="temperature">Temperatur</div>
        <div class="sensor-btn" data-sensor="humidity">Feuchtigkeit</div>
        <div class="sensor-btn" data-sensor="pressure">Luftdruck</div>
    </div>

    <!-- Chart -->
    <div class="chart-box">
        <canvas id="mainChart"></canvas>
    </div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, get }
    from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAfIU041dyNBiCC_ywpJiwf8mABJVsT-lw",
  authDomain: "meine-wetterstation.firebaseapp.com",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "meine-wetterstation",
  storageBucket: "meine-wetterstation.appspot.com",
  messagingSenderId: "593494014586",
  appId: "1:593494014586:web:a05ed68495b1b16d6059c3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ================= OPENWEATHER ================= */
const OWM_API_KEY = "27602f1bbb8e3dd3587a1da6e3de24b6";
const LAT = 47.366;
const LON = 16.233;

function formatTime(ts) {
    return new Date(ts * 1000).toLocaleTimeString("de-AT", {
        hour: "2-digit",
        minute: "2-digit"
    });
}

async function loadOpenWeather() {
    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&units=metric&lang=de&appid=${OWM_API_KEY}&_=${Date.now()}`;
        const res = await fetch(url);

        if (!res.ok) return;

        const data = await res.json();

        const icon =
            data.weather?.[0]?.icon ||
            data.weather?.icon ||
            data.weather?.["0"]?.icon;

        if (icon) {
            document.getElementById("weather-icon").src =
                `https://openweathermap.org/img/wn/${icon}@2x.png`;
        }

        document.getElementById("sunrise").innerText =
            "Sonnenaufgang: " + formatTime(data.sys.sunrise);

        document.getElementById("sunset").innerText =
            "Sonnenuntergang: " + formatTime(data.sys.sunset);

    } catch (e) {
        console.error("OWM Fehler:", e);
    }
}

/* ================= GPS ================= */
function loadGPS() {
    if (!navigator.geolocation) {
        document.getElementById("gps").innerText = "GPS nicht verfügbar";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude.toFixed(5);
            const lon = pos.coords.longitude.toFixed(5);
            document.getElementById("gps").innerText = `GPS: ${lat}, ${lon}`;
        },
        err => {
            document.getElementById("gps").innerText = "GPS blockiert – Standort erlauben";
        },
        { enableHighAccuracy: true, timeout: 5000 }
    );
}

/* ================= HISTORY LADEN ================= */
async function loadHistory(sensor) {
    const year = new Date().getFullYear();
    const snap = await get(ref(db, `history/${year}/${sensor}`));
    return snap.val() || {};
}

/* ================= LABEL FORMATTER ================= */
function formatLabel(t, range) {
    const d = new Date(t);

    if (range === "today") {
        return d.toLocaleTimeString("de-AT", {
            hour: "2-digit",
            minute: "2-digit"
        });
    }

    if (range === "week") {
        return d.toLocaleString("de-AT", {
            weekday: "short",
            hour: "2-digit"
        });
    }

    if (range === "month") {
        return d.toLocaleDateString("de-AT", {
            day: "2-digit",
            month: "2-digit"
        });
    }

    if (range === "year") {
        return d.toLocaleDateString("de-AT", {
            month: "short"
        });
    }
}

/* ================= FILTER ================= */
function filterData(data, hours, range) {
    const now = Date.now();
    const limit = now - hours * 3600 * 1000;

    const timestamps = Object.keys(data)
        .map(t => Number(t) * 1000)
        .filter(t => t >= limit)
        .sort((a, b) => a - b);

    return timestamps.map(t => ({
        time: formatLabel(t, range),
        value: data[Math.floor(t / 1000)]
    }));
}

/* ================= GRADIENT COLORS ================= */
function createGradient(ctx, color) {
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, color + "FF");
    gradient.addColorStop(1, color + "00");
    return gradient;
}

const sensorColors = {
    temperature: "#ff4d4d",
    humidity: "#4da3ff",
    pressure: "#ffd24d"
};

/* ================= CHART ================= */
let chart;
function drawChart(data) {
    const ctx = document.getElementById("mainChart").getContext("2d");

    if (chart) chart.destroy();

    const baseColor = sensorColors[sensor];
    const gradient = createGradient(ctx, baseColor);

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: data.map(d => d.time),
            datasets: [{
                label:
                    sensor === "temperature" ? "Temperatur (°C)" :
                    sensor === "humidity" ? "Feuchtigkeit (%)" :
                    "Luftdruck (hPa)",
                data: data.map(d => d.value),
                borderColor: baseColor,
                backgroundColor: gradient,
                borderWidth: 1.5,
                tension: 0.35,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 0
            }]
        },
        options: {
            scales: {
                x: { ticks: { color: "white" } },
                y: { ticks: { color: "white" } }
            },
            plugins: {
                legend: { labels: { color: "white" } }
            }
        }
    });
}

/* ================= INTERAKTION ================= */
let range = "today";
let sensor = "temperature";

async function updateChart() {
    const data = await loadHistory(sensor);

    let hours = 24;
    if (range === "week") hours = 24 * 7;
    if (range === "month") hours = 24 * 30;
    if (range === "year") hours = 24 * 365;

    const filtered = filterData(data, hours, range);
    drawChart(filtered);
}

document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
        document.querySelector(".tab.active").classList.remove("active");
        tab.classList.add("active");
        range = tab.dataset.range;
        updateChart();
    });
});

document.querySelectorAll(".sensor-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelector(".sensor-btn.active").classList.remove("active");
        btn.classList.add("active");
        sensor = btn.dataset.sensor;
        updateChart();
    });
});

/* ================= START ================= */
loadGPS();
loadOpenWeather();
updateChart();

</script>
</div>
</body>
</html>

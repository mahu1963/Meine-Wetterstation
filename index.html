<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wetterstation ‚Äì Martin Huber</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { background:#111; color:#fff; font-family:Arial; margin:0; padding:20px; }
    h2 { margin-top:0; }
    #live, #openweather, #gps, #clock, #rangeInfo { margin-bottom:12px; font-size:1.1rem; }
    #weatherIcon { font-size:48px; margin-bottom:10px; }
    button { padding:6px 12px; margin-right:6px; margin-bottom:6px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; cursor:pointer; }
    button.active { background:#666; }
    button:hover { background:#444; }
    #mainChart { width:100%; height:320px; }
</style>
</head>

<body>

<h2>üåßÔ∏è Wetterstation ‚Äì Martin Huber</h2>

<!-- Fixes Icon Sonne + Wolke -->
<div id="weatherIcon">üå§Ô∏è</div>

<div id="clock">‚è±Ô∏è Uhr l√§dt‚Ä¶</div>
<div id="live">Live-Daten werden geladen‚Ä¶</div>
<div id="openweather">OpenWeather l√§dt‚Ä¶</div>
<div id="gps">GPS l√§dt‚Ä¶</div>

<div>
    <button id="btnWeek" onclick="setRange('week')">Woche</button>
    <button id="btnMonth" onclick="setRange('month')">Monat</button>
    <button id="btnYear" onclick="setRange('year')">Jahr</button>
    <button onclick="saveChart()">Diagramm speichern</button>
</div>

<!-- Zeitraum-Anzeige -->
<div id="rangeInfo" style="color:#ccc; margin-bottom:10px;"></div>

<canvas id="mainChart"></canvas>

<script type="module">

/* ================= FIREBASE ================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAfIU041dyNBiCC_ywpJiwf8mABJVsT-lw",
  authDomain: "meine-wetterstation.firebaseapp.com",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "meine-wetterstation",
  storageBucket: "meine-wetterstation.appspot.com",
  messagingSenderId: "593494014586",
  appId: "1:593494014586:web:a05ed68495b1b16d6059c3",
  measurementId: "G-ST9RCRW888"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ================= LIVE-DATEN (ESP32) ================= */

let lastTemp = null;

function tempColor(t) {
    if (t <= -5) return "#4da3ff";
    if (t < 5)   return "#7fbfff";
    if (t < 15)  return "#a0ffb0";
    if (t < 25)  return "#ffe680";
    if (t < 30)  return "#ffb347";
    return "#ff5c5c";
}

function trendArrow(curr, prev) {
    if (prev === null) return "‚óè";
    if (curr > prev) return "‚ñ≤";
    if (curr < prev) return "‚ñº";
    return "‚óè";
}

function trendColor(curr, prev) {
    if (prev === null) return "#ccc";
    if (curr > prev) return "red";
    if (curr < prev) return "deepskyblue";
    return "#ccc";
}

onValue(ref(db, "/weather/temperature"), (snap) => {
    const temp = snap.val();
    if (temp == null) return;

    const arrow = trendArrow(temp, lastTemp);
    const color = trendColor(temp, lastTemp);
    lastTemp = temp;

    document.getElementById("live").innerHTML =
        `üå°Ô∏è <span style="color:${color}">${arrow}</span> ${temp.toFixed(1)} ¬∞C`;
});

onValue(ref(db, "/weather/humidity"), (snap) => {
    const hum = snap.val();
    if (hum == null) return;
    document.getElementById("live").innerHTML += `<br>üíß ${hum.toFixed(1)} %`;
});

onValue(ref(db, "/weather/pressure"), (snap) => {
    const pres = snap.val();
    if (pres == null) return;
    document.getElementById("live").innerHTML += `<br>üß≠ ${pres.toFixed(1)} hPa`;
});

onValue(ref(db, "/weather/timestamp"), (snap) => {
    const t = snap.val();
    if (t == null) return;
    const dt = new Date(t * 1000).toLocaleString("de-AT");
    document.getElementById("live").innerHTML += `<br>üìÖ ${dt}`;
});

/* ================= OPENWEATHER (LIVE) ================= */

async function loadOpenWeather() {
    const apiKey = "27602f1bbb8e3dd3587a1da6e3de24b6";
    const lat = 47.366;
    const lon = 16.266;

    if (!apiKey || apiKey.length < 30) {
        document.getElementById("openweather").innerHTML = "Bitte OpenWeather API-Key eintragen.";
        return;
    }

    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=de&appid=${apiKey}`;
        const res = await fetch(url);

        if (!res.ok) {
            document.getElementById("openweather").innerHTML = `OpenWeather Fehler: ${res.status}`;
            return;
        }

        const data = await res.json();

        document.getElementById("openweather").innerHTML = `
            ‚òÅÔ∏è ${data.weather[0].description}<br>
            üå°Ô∏è ${data.main.temp.toFixed(1)} ¬∞C<br>
            üíß ${data.main.humidity}%<br>
            üå¨Ô∏è ${data.wind.speed} m/s
        `;
    } catch (err) {
        document.getElementById("openweather").innerHTML = "OpenWeather Fehler in der Abfrage.";
    }
}

/* ================= GPS (LIVE) ================= */

function loadGPS() {
    if (!navigator.geolocation) {
        document.getElementById("gps").innerHTML = "‚ùå GPS nicht verf√ºgbar";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude.toFixed(5);
            const lon = pos.coords.longitude.toFixed(5);
            document.getElementById("gps").innerHTML = `üìç ${lat}, ${lon}`;
        },
        () => {
            document.getElementById("gps").innerHTML = "‚ùå GPS blockiert";
        }
    );
}

/* ================= LIVE-UHR ================= */

setInterval(() => {
    document.getElementById("clock").innerHTML =
        "‚è±Ô∏è " + new Date().toLocaleString("de-AT");
}, 1000);

/* ================= CHART ================= */

const ctx = document.getElementById("mainChart").getContext("2d");
let mainChart = new Chart(ctx, {
    type: "line",
    data: { labels: [], datasets: [
        { label:"Temperatur (¬∞C)", data:[], borderColor:"#ffb347", backgroundColor:"rgba(255,179,71,0.2)", tension:0.2, pointRadius:0 },
        { label:"Luftfeuchtigkeit (%)", data:[], borderColor:"#4da3ff", backgroundColor:"rgba(77,163,255,0.2)", tension:0.2, pointRadius:0 },
        { label:"Luftdruck (hPa)", data:[], borderColor:"#a0ffb0", backgroundColor:"rgba(160,255,176,0.2)", tension:0.2, pointRadius:0, yAxisID:"y2" }
    ]},
    options: {
        responsive:true, maintainAspectRatio:false,
        scales:{
            x:{ ticks:{color:"#ccc"}, grid:{color:"#333"} },
            y:{ ticks:{color:"#ccc"}, grid:{color:"#333"} },
            y2:{ ticks:{color:"#ccc"}, grid:{display:false} }
        },
        plugins:{ legend:{ labels:{color:"#fff"} } }
    }
});

/* ================= HISTORY ================= */

let historyRange = "week";
let tempData={}, humData={}, presData={};

function updateRangeInfo() {
    const now = new Date();
    let text = "";

    if (historyRange === "week") {
        const start = new Date(Date.now() - 7*24*3600*1000);
        text = `Woche: ${start.toLocaleDateString("de-AT")} ‚Äì ${now.toLocaleDateString("de-AT")}`;
    }

    if (historyRange === "month") {
        text = `Monat: ${now.toLocaleString("de-AT", { month:"long", year:"numeric" })}`;
    }

    if (historyRange === "year") {
        text = `Jahr: ${now.getFullYear()}`;
    }

    document.getElementById("rangeInfo").innerHTML = text;
}

function setRange(r) {
    historyRange = r;

    localStorage.setItem("historyRange", r);

    document.getElementById("btnWeek").classList.remove("active");
    document.getElementById("btnMonth").classList.remove("active");
    document.getElementById("btnYear").classList.remove("active");

    document.getElementById("btn" + r.charAt(0).toUpperCase() + r.slice(1)).classList.add("active");

    updateRangeInfo();
    loadHistory();
}
window.setRange = setRange;

function loadHistory() {
    const baseTemp = `/weather/history/temperature`;
    const baseHum  = `/weather/history/humidity`;
    const basePres = `/weather/history/pressure`;

    function updateChart() {
        const nowSec = Date.now()/1000;
        let limit = nowSec - 7*24*3600;
        if (historyRange==="month") limit = nowSec - 30*24*3600;
        if (historyRange==="year")  limit = nowSec - 365*24*3600;

        const timestamps = Object.keys(tempData||{})
            .map(t=>parseInt(t))
            .filter(t=>t>=limit)
            .sort((a,b)=>a-b);

        const labels=[], temps=[], hums=[], press=[];
        timestamps.forEach(ts=>{
            const d=new Date(ts*1000);

            let label = "";
            if (historyRange === "week")
                label = d.toLocaleString("de-AT",{hour:"2-digit",minute:"2-digit"});
            if (historyRange === "month")
                label = d.toLocaleString("de-AT",{day:"2-digit",month:"2-digit"});
            if (historyRange === "year")
                label = d.toLocaleString("de-AT",{month:"2-digit"});

            labels.push(label);

            temps.push(tempData[ts]??null);
            hums.push(humData[ts]??null);
            press.push(presData[ts]??null);
        });

        mainChart.data.labels = labels;
        mainChart.data.datasets[0].data = temps;
        mainChart.data.datasets[1].data = hums;
        mainChart.data.datasets[2].data = press;
        mainChart.update();
    }

    onValue(ref(db, baseTemp),(s)=>{ tempData=s.val()||{}; updateChart(); });
    onValue(ref(db, baseHum),(s)=>{ humData=s.val()||{}; updateChart(); });
    onValue(ref(db, basePres),(s)=>{ presData=s.val()||{}; updateChart(); });
}

/* ================= DIAGRAMM SPEICHERN ================= */

function saveChart() {
    const link=document.createElement('a');
    link.download="wetterstation-diagramm.png";
    link.href=mainChart.toBase64Image();
    link.click();
}
window.saveChart = saveChart;

/* ================= INIT ================= */

loadOpenWeather();
loadGPS();

const saved = localStorage.getItem("historyRange") || "week";
setRange(saved);

// LIVE-Updates
setInterval(loadOpenWeather, 5 * 60 * 1000);
setInterval(loadGPS, 10000);

</script>
</body>
</html>

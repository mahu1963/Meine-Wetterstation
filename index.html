<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Wetterstation Stuben‑Bernstein</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin: 0;
    padding: 0;
    background: #0d0d0d;
    color: white;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
}

.main {
    padding: 30px 20px 40px;
    max-width: 1100px;
    margin: 0 auto;
}

#header {
    text-align: center;
    margin-bottom: 30px;
}

#header h1 {
    margin: 10px 0 0;
    font-size: 28px;
}

#header h3 {
    margin: 5px 0 10px;
    font-weight: 400;
    opacity: 0.8;
}

#gps {
    opacity: 0.7;
    font-size: 15px;
}

/* Sonnenaufgang/Sonnenuntergang */
.sun-container {
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.sun-times {
    display: flex;
    justify-content: space-between;
    width: 260px;
    font-size: 14px;
    opacity: 0.8;
}

.sun-bar {
    position: relative;
    margin-top: 8px;
    width: 260px;
    height: 6px;
    border-radius: 999px;
    background: linear-gradient(90deg, #ff9800, #ffc107, #ff9800);
    overflow: hidden;
}

.sun-progress {
    position: absolute;
    top: -6px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #fff176;
    box-shadow: 0 0 12px rgba(255, 241, 118, 0.9);
    transition: left 1s ease-out;
}

/* Karten */
.cards {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 25px;
}

.card {
    flex: 1;
    min-width: 180px;
    background: #1c1c1e;
    padding: 20px;
    border-radius: 18px;
}

.card .label {
    font-size: 14px;
    opacity: 0.7;
}

.card .value {
    font-size: 36px;
    font-weight: 600;
    margin-top: 5px;
}

/* Radar */
#radar-card {
    margin-top: 25px;
    background: #1c1c1e;
    padding: 15px;
    border-radius: 18px;
}

#radar-card h2 {
    margin: 0 0 10px;
    font-size: 18px;
}

#radar-frame {
    width: 100%;
    height: 260px;
    border: none;
    border-radius: 12px;
}

/* Charts */
.chart-container {
    margin-top: 30px;
    background: #1c1c1e;
    padding: 20px;
    border-radius: 18px;
}

.chart-container h2 {
    margin: 0 0 10px;
    font-size: 18px;
}
</style>
</head>

<body>

<div class="main">

    <!-- Kopfbereich -->
    <div id="header">
        <img id="weather-icon" src="" alt="Wetter" style="width:120px; height:120px;">
        <h1>Stuben‑Bernstein</h1>
        <h3>Martin Huber</h3>
        <div id="gps">GPS lädt…</div>

        <div class="sun-container">
            <div class="sun-times">
                <span id="sunrise">Aufgang --:--</span>
                <span id="sunset">Untergang --:--</span>
            </div>
            <div class="sun-bar">
                <div class="sun-progress" id="sun-progress" style="left:0%;"></div>
            </div>
        </div>
    </div>

    <!-- Live-Karten -->
    <div class="cards">
        <div class="card">
            <div class="label">Temperatur</div>
            <div class="value" id="temp">--</div>
        </div>

        <div class="card">
            <div class="label">Feuchtigkeit</div>
            <div class="value" id="hum">--</div>
        </div>

        <div class="card">
            <div class="label">Luftdruck</div>
            <div class="value" id="pres">--</div>
        </div>
    </div>

    <!-- Regenradar -->
    <div id="radar-card">
        <h2>Regenradar</h2>
        <iframe
            id="radar-frame"
            src="https://www.rainviewer.com/map.html?loc=47.366,16.233,9&oFa=1&oC=1&oU=1&oCS=1&oF=1&oAP=1&c=3&o=83&lm=1&layer=radar&sm=1&sn=1"
            loading="lazy">
        </iframe>
    </div>

    <!-- Charts -->
    <div class="chart-container">
        <h2>Heute</h2>
        <canvas id="chart-today"></canvas>
    </div>

    <div class="chart-container">
        <h2>Woche</h2>
        <canvas id="chart-week"></canvas>
    </div>

    <div class="chart-container">
        <h2>Monat</h2>
        <canvas id="chart-month"></canvas>
    </div>

    <div class="chart-container">
        <h2>Jahr</h2>
        <canvas id="chart-year"></canvas>
    </div>

</div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, get }
    from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAfIU041dyNBiCC_ywpJiwf8mABJVsT-lw",
  authDomain: "meine-wetterstation.firebaseapp.com",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "meine-wetterstation",
  storageBucket: "meine-wetterstation.appspot.com",
  messagingSenderId: "593494014586",
  appId: "1:593494014586:web:a05ed68495b1b16d6059c3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ================= OPENWEATHERMAP ================= */
const OWM_API_KEY = "27602f1bbb8e3dd3587a1da6e3de24b6";   /* <--- HIER EINTRAGEN */
const OWM_LAT = 47.366;
const OWM_LON = 16.233;

async function loadOpenWeather() {
    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${OWM_LAT}&lon=${OWM_LON}&units=metric&lang=de&appid=${OWM_API_KEY}&_=${Date.now()}`;
        const res = await fetch(url);

        if (!res.ok) {
            console.warn("OpenWeather Fehler:", res.status);
            return;
        }

        const data = await res.json();

        if (data.weather && data.weather[0]) {
            const iconCode = data.weather[0].icon;
            const iconUrl = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
            document.getElementById("weather-icon").src = iconUrl;
        }

        if (data.sys) {
            const sunrise = data.sys.sunrise * 1000;
            const sunset  = data.sys.sunset * 1000;

            const fmt = d => new Date(d).toLocaleTimeString("de-AT", {
                hour: "2-digit",
                minute: "2-digit"
            });

            document.getElementById("sunrise").innerText = "Aufgang " + fmt(sunrise);
            document.getElementById("sunset").innerText  = "Untergang " + fmt(sunset);

            updateSunProgress(sunrise, sunset);
        }

    } catch (e) {
        console.error("OpenWeather Fehler:", e);
    }
}

/* Sonnen-Animation */
function updateSunProgress(sunriseMs, sunsetMs) {
    const now = Date.now();
    let pos = 0;

    if (now <= sunriseMs) pos = 0;
    else if (now >= sunsetMs) pos = 100;
    else {
        const total = sunsetMs - sunriseMs;
        const passed = now - sunriseMs;
        pos = (passed / total) * 100;
    }

    document.getElementById("sun-progress").style.left = `${pos}%`;
}

/* ================= GPS ================= */
function loadGPS() {
    if (!navigator.geolocation) {
        document.getElementById("gps").innerText = "GPS nicht verfügbar";
        return;
    }

    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(5);
        const lon = pos.coords.longitude.toFixed(5);
        document.getElementById("gps").innerText = `GPS: ${lat}, ${lon}`;
    }, () => {
        document.getElementById("gps").innerText = "GPS verweigert";
    });
}

/* ================= LIVE-WERTE (Firebase) ================= */
onValue(ref(db, "weather"), snap => {
    const d = snap.val();
    if (!d) return;

    document.getElementById("temp").innerText = d.temperature.toFixed(1) + "°C";
    document.getElementById("hum").innerText  = d.humidity.toFixed(1) + "%";
    document.getElementById("pres").innerText = d.pressure.toFixed(1) + " hPa";
});

/* ================= CHART-FUNKTION ================= */
function createChart(canvasId, labels, data, color, mode = "auto") {
    const ctx = document.getElementById(canvasId).getContext("2d");

    return new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [{
                data,
                borderColor: color,
                backgroundColor: color,
                tension: 0.35,
                pointRadius: mode === "today" ? 3 : 4,
                pointHoverRadius: 7,
                pointBackgroundColor: color,
                pointBorderColor: "#ffffff",
                pointBorderWidth: 2,
                spanGaps: false
            }]
        },
        options: {
            responsive: true,
            animation: false,
            scales: {
                x: {
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: mode === "today" ? 10 : 10,
                        font: { size: 14 },
                        padding: 10,
                        maxRotation: 0,
                        minRotation: 0,
                        callback: (value, index) => labels[index]
                    }
                },
                y: { beginAtZero: false }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

/* ================= HISTORY LADEN ================= */
async function loadHistory(path) {
    const snap = await get(ref(db, path));
    return snap.val() || {};
}

/* ================= HEUTE ================= */
async function loadToday() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");

    const data = await loadHistory(`history/${y}/${m}/${da}`);

    const times = Object.keys(data).sort();
    const temps = times.map(t => data[t].temperature);

    createChart("chart-today", times, temps, "#ff9800", "today");
}

/* ================= WOCHE ================= */
async function loadWeek() {
    const now = new Date();
    const labels = [];
    const temps = [];
    const days = ["So","Mo","Di","Mi","Do","Fr","Sa"];

    for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);

        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");

        const dayData = await loadHistory(`history/${y}/${m}/${da}`);
        const keys = Object.keys(dayData);

        temps.push(keys.length ? dayData[keys[keys.length - 1]].temperature : null);
        labels.push(days[d.getDay()]);
    }

    createChart("chart-week", labels, temps, "#4fc3f7");
}

/* ================= MONAT ================= */
async function loadMonth() {
    const now = new Date();
    const labels = [];
    const temps = [];

    for (let i = 29; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);

        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");

        const dayData = await loadHistory(`history/${y}/${m}/${da}`);
        const keys = Object.keys(dayData);

        temps.push(keys.length ? dayData[keys[keys.length - 1]].temperature : null);
        labels.push(da);
    }

    createChart("chart-month", labels, temps, "#81c784");
}

/* ================= JAHR ================= */
async function loadYear() {
    const now = new Date();
    const labels = ["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
    const temps = [];

    for (let month = 0; month < 12; month++) {
        const y = now.getFullYear();
        const m = String(month + 1).padStart(2, "0");

        const monthSnap = await get(ref(db, `history/${y}/${m}`));
        const monthData = monthSnap.val() || {};

        let lastTemp = null;

        Object.keys(monthData).forEach(day => {
            const entries = monthData[day];
            const keys = Object.keys(entries);
            if (keys.length) lastTemp = entries[keys[keys.length - 1]].temperature;
        });

        temps.push(lastTemp);
    }

    createChart("chart-year", labels, temps, "#ba68c8");
}

/* ================= ALLES LADEN ================= */
async function loadAll() {
    loadGPS();
    loadOpenWeather();
    await loadToday();
    await loadWeek();
    await loadMonth();
    await loadYear();
}

loadAll();
setInterval(loadAll, 60000);
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Wetterstation Dashboard</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f0f0f0;
        margin: 20px;
    }
    h1 {
        text-align: center;
    }
    #live {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin-bottom: 30px;
        font-size: 22px;
    }
    button {
        padding: 10px 20px;
        margin: 5px;
        font-size: 16px;
        cursor: pointer;
    }
    #chart-container {
        width: 90%;
        margin: auto;
    }
</style>
</head>

<body>

<h1>Wetterstation Dashboard</h1>

<div id="live">
    <div>ðŸŒ¡ Temperatur: <span id="temp">--</span> Â°C</div>
    <div>ðŸ’§ Feuchte: <span id="hum">--</span> %</div>
    <div>ðŸŒ¬ Druck: <span id="pres">--</span> hPa</div>
</div>

<div style="text-align:center;">
    <button onclick="loadTodayHistory()">Heute</button>
    <button onclick="loadWeekHistory()">Woche</button>
    <button onclick="loadMonthHistory()">Monat</button>
    <button onclick="loadYearHistory()">Jahr</button>
</div>

<div id="chart-container">
    <canvas id="chart"></canvas>
</div>

<script>
// ------------------------------------------------------------
// Firebase KONFIGURATION â€” HIER EINTRAGEN
// ------------------------------------------------------------
const firebaseConfig = {
    apiKey: "DEIN_API_KEY",
    authDomain: "DEINE_DOMAIN",
    databaseURL: "DEINE_DATABASE_URL",
    projectId: "DEIN_PROJECT_ID",
    storageBucket: "DEIN_BUCKET",
    messagingSenderId: "DEINE_SENDER_ID",
    appId: "DEINE_APP_ID"
};

firebase.initializeApp(firebaseConfig);

// ------------------------------------------------------------
// LIVE-WERTE LADEN
// ------------------------------------------------------------
firebase.database().ref("weather").on("value", snap => {
    const d = snap.val();
    if (!d) return;

    document.getElementById("temp").innerText = d.temperature.toFixed(1);
    document.getElementById("hum").innerText  = d.humidity.toFixed(1);
    document.getElementById("pres").innerText = d.pressure.toFixed(1);
});

// ------------------------------------------------------------
// HISTORY LADEN (Hilfsfunktion)
// ------------------------------------------------------------
function loadHistoryPath(path, callback) {
    firebase.database().ref(path).once("value", snapshot => {
        const data = snapshot.val();
        if (!data) {
            callback([], [], [], []);
            return;
        }

        const times = [];
        const temps = [];
        const hums = [];
        const press = [];

        const keys = Object.keys(data).sort();

        keys.forEach(key => {
            const entry = data[key];
            if (!entry) return;

            times.push(key);
            temps.push(entry.temperature);
            hums.push(entry.humidity);
            press.push(entry.pressure);
        });

        callback(times, temps, hums, press);
    });
}

// ------------------------------------------------------------
// CHART AKTUALISIEREN
// ------------------------------------------------------------
let chart;

function updateChart(times, temps, hums, press) {
    const ctx = document.getElementById("chart").getContext("2d");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: times,
            datasets: [
                {
                    label: "Temperatur (Â°C)",
                    data: temps,
                    borderColor: "orange",
                    fill: false
                },
                {
                    label: "Feuchte (%)",
                    data: hums,
                    borderColor: "blue",
                    fill: false
                },
                {
                    label: "Druck (hPa)",
                    data: press,
                    borderColor: "green",
                    fill: false
                }
            ]
        }
    });
}

// ------------------------------------------------------------
// TAGESVERLAUF
// ------------------------------------------------------------
function loadTodayHistory() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");

    loadHistoryPath(`history/${y}/${m}/${d}`, updateChart);
}

// ------------------------------------------------------------
// WOCHENVERLAUF
// ------------------------------------------------------------
function loadWeekHistory() {
    const now = new Date();
    const promises = [];

    for (let i = 0; i < 7; i++) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);

        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");

        const path = `history/${y}/${m}/${da}`;

        promises.push(
            new Promise(resolve => {
                loadHistoryPath(path, (t, te, h, p) => resolve({ t, te, h, p }));
            })
        );
    }

    Promise.all(promises).then(days => {
        const times = [], temps = [], hums = [], press = [];

        days.reverse().forEach(day => {
            day.t.forEach((time, i) => {
                times.push(time);
                temps.push(day.te[i]);
                hums.push(day.h[i]);
                press.push(day.p[i]);
            });
        });

        updateChart(times, temps, hums, press);
    });
}

// ------------------------------------------------------------
// MONATSVERLAUF (30 Tage)
// ------------------------------------------------------------
function loadMonthHistory() {
    const now = new Date();
    const promises = [];

    for (let i = 0; i < 30; i++) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);

        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");

        const path = `history/${y}/${m}/${da}`;

        promises.push(
            new Promise(resolve => {
                loadHistoryPath(path, (t, te, h, p) => resolve({ t, te, h, p }));
            })
        );
    }

    Promise.all(promises).then(days => {
        const times = [], temps = [], hums = [], press = [];

        days.reverse().forEach(day => {
            day.t.forEach((time, i) => {
                times.push(time);
                temps.push(day.te[i]);
                hums.push(day.h[i]);
                press.push(day.p[i]);
            });
        });

        updateChart(times, temps, hums, press);
    });
}

// ------------------------------------------------------------
// JAHRESVERLAUF (365 Tage)
// ------------------------------------------------------------
function loadYearHistory() {
    const now = new Date();
    const promises = [];

    for (let i = 0; i < 365; i++) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);

        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");

        const path = `history/${y}/${m}/${da}`;

        promises.push(
            new Promise(resolve => {
                loadHistoryPath(path, (t, te, h, p) => resolve({ t, te, h, p }));
            })
        );
    }

    Promise.all(promises).then(days => {
        const times = [], temps = [], hums = [], press = [];

        days.reverse().forEach(day => {
            day.t.forEach((time, i) => {
                times.push(time);
                temps.push(day.te[i]);
                hums.push(day.h[i]);
                press.push(day.p[i]);
            });
        });

        updateChart(times, temps, hums, press);
    });
}

// ------------------------------------------------------------
// STANDARD: Tagesverlauf beim Start
// ------------------------------------------------------------
loadTodayHistory();

</script>
</body>
</html>

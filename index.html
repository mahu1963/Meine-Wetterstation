<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<title>Wetterstation</title>

<!-- PWA -->
<link rel="apple-touch-icon" href="icon.png">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#0d0d0d">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin: 0;
    padding: 0;
    background: #0d0d0d;
    color: white;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
}

.main {
    padding: 40px;
    padding-top: calc(40px + env(safe-area-inset-top));
}

/* HEADER */
.header {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 25px;
}

.weather-icon {
    font-size: 90px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.header-info .title {
    font-size: 36px;
    font-weight: 700;
}

.header-info .subtitle {
    font-size: 22px;
    opacity: 0.8;
}

.header-info .gps,
.header-info .datetime {
    font-size: 18px;
    opacity: 0.7;
}

/* CARDS */
.cards {
    display: flex;
    gap: 30px;
    margin-top: 30px;
}

.card {
    flex: 1;
    background: #1c1c1e;
    padding: 30px;
    border-radius: 22px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
}

.card .label {
    font-size: 20px;
    opacity: 0.8;
}

.card .value {
    font-size: 48px;
    font-weight: 600;
    margin-top: 10px;
}

.trend svg {
    width: 32px;
    height: 32px;
}

/* CHART CONTAINERS */
.chart-container {
    margin-top: 40px;
    background: #1c1c1e;
    padding: 25px;
    border-radius: 22px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
}

h2 {
    margin-top: 50px;
    font-size: 28px;
    font-weight: 600;
}

@media (max-width: 700px) {
    .cards {
        flex-direction: column;
    }
}
</style>
</head>

<body>

<div class="main">

    <div class="header">
        <div id="weatherIcon" class="weather-icon">‚õÖ</div>

        <div class="header-info">
            <div class="title">Stuben‚ÄëBernstein</div>
            <div class="subtitle">Martin Huber</div>
            <div class="gps" id="gps">GPS l√§dt‚Ä¶</div>
            <div class="datetime" id="datetime">--:--</div>
        </div>
    </div>

    <div class="cards">
        <div class="card">
            <div class="label">Temperatur</div>
            <div class="value" id="temp">--</div>
            <div class="trend" id="trend-temp"></div>
        </div>

        <div class="card">
            <div class="label">Feuchtigkeit</div>
            <div class="value" id="hum">--</div>
            <div class="trend" id="trend-hum"></div>
        </div>

        <div class="card">
            <div class="label">Luftdruck</div>
            <div class="value" id="pres">--</div>
            <div class="trend" id="trend-pres"></div>
        </div>
    </div>

    <!-- 4 gro√üe Charts -->
    <h2>Heute</h2>
    <div class="chart-container"><canvas id="chart-today"></canvas></div>

    <h2>Woche</h2>
    <div class="chart-container"><canvas id="chart-week"></canvas></div>

    <h2>Monat</h2>
    <div class="chart-container"><canvas id="chart-month"></canvas></div>

    <h2>Jahr</h2>
    <div class="chart-container"><canvas id="chart-year"></canvas></div>

</div>

<!-- JAVASCRIPT -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, get }
    from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAfIU041dyNBiCC_ywpJiwf8mABJVsT-lw",
  authDomain: "meine-wetterstation.firebaseapp.com",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "meine-wetterstation",
  storageBucket: "meine-wetterstation.appspot.com",
  messagingSenderId: "593494014586",
  appId: "1:593494014586:web:a05ed68495b1b16d6059c3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* DATUM & UHRZEIT */
function updateDateTime() {
    const now = new Date();
    document.getElementById("datetime").innerText =
        now.toLocaleDateString("de-DE") + " " + now.toLocaleTimeString("de-DE");
}
setInterval(updateDateTime, 1000);
updateDateTime();

/* GPS */
function loadGPS() {
    if (!navigator.geolocation) {
        document.getElementById("gps").innerText = "GPS nicht verf√ºgbar";
        return;
    }
    navigator.geolocation.getCurrentPosition(
        pos => {
            document.getElementById("gps").innerText =
                `GPS: ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
        },
        () => document.getElementById("gps").innerText = "GPS deaktiviert"
    );
}
loadGPS();

/* WETTER ICON */
function updateWeatherIcon(temp, hum, pres) {
    const icon = document.getElementById("weatherIcon");

    if (pres < 990)       icon.innerHTML = "üåßÔ∏è";
    else if (hum > 85)    icon.innerHTML = "‚òÅÔ∏è";
    else if (temp < 0)    icon.innerHTML = "‚ùÑÔ∏è";
    else if (temp > 25)   icon.innerHTML = "‚òÄÔ∏è";
    else                  icon.innerHTML = "‚õÖ";
}

/* TREND */
let lastTemp = null, lastHum = null, lastPres = null;

function updateTrend(id, last, current) {
    const el = document.getElementById(id);

    if (last === null) {
        el.innerHTML = "";
        return current;
    }

    const diff = current - last;

    if (Math.abs(diff) < 0.05) {
        el.innerHTML = "";
    } else if (diff > 0) {
        el.innerHTML = `<svg width="24" height="24"><polygon points="12,4 20,20 4,20" fill="#4fc3f7"/></svg>`;
    } else {
        el.innerHTML = `<svg width="24" height="24"><polygon points="12,20 20,4 4,4" fill="#ff5252"/></svg>`;
    }

    return current;
}

/* ‚≠ê LIVE-WERTE LADEN */
onValue(ref(db, "weather"), snap => {
    const d = snap.val();
    if (!d) return;

    const temp = d.temperature;
    const hum  = d.humidity;
    const pres = d.pressure;

    document.getElementById("temp").innerText = temp.toFixed(1) + "¬∞C";
    document.getElementById("hum").innerText  = hum.toFixed(1) + "%";
    document.getElementById("pres").innerText = pres.toFixed(1) + " hPa";

    updateWeatherIcon(temp, hum, pres);

    lastTemp = updateTrend("trend-temp", lastTemp, temp);
    lastHum  = updateTrend("trend-hum",  lastHum,  hum);
    lastPres = updateTrend("trend-pres", lastPres, pres);
});

/* ‚≠ê CHART-FUNKTION */
function createChart(canvasId, labels, data, color, mode = "auto") {

    const ctx = document.getElementById(canvasId).getContext("2d");

    return new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [{
                data,
                borderColor: color,
                backgroundColor: color,
                tension: 0.35,
                pointRadius: 4,
                pointHoverRadius: 7,
                pointBackgroundColor: color,
                pointBorderColor: "#ffffff",
                pointBorderWidth: 2,
                spanGaps: false
            }]
        },
        options: {
            responsive: true,
            animation: false,

            scales: {
                x: {
                    ticks: {
                        // Nur HEUTE ausd√ºnnen
                        autoSkip: mode === "today",
                        maxTicksLimit: mode === "today" ? 12 : undefined,

                        // Schriftgr√∂√üe & Abstand
                        font: { size: 14 },
                        padding: 12,

                        // Heute leicht drehen
                        maxRotation: mode === "today" ? 45 : 0,
                        minRotation: mode === "today" ? 20 : 0,

                        callback: function(value, index) {
                            let label = labels[index];

                            // Monatstage h√ºbsch formatieren
                            if (mode === "month" && /^\d{1,2}$/.test(label)) {
                                return label.toString().padStart(2, "0");
                            }

                            return label;
                        }
                    }
                },
                y: {
                    beginAtZero: false
                }
            },

            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: "#1c1c1e",
                    titleColor: "#fff",
                    bodyColor: "#fff",
                    borderColor: color,
                    borderWidth: 1
                }
            }
        }
    });
}

/* ‚≠ê HEUTE */
async function loadToday() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");

    const data = await loadHistory(`history/${y}/${m}/${da}`);

    const times = Object.keys(data).sort();
    const temps = times.map(t => data[t].temperature);

    createChart("chart-today", times, temps, "#ff9800", "today");
}

/* ‚≠ê WOCHE */
async function loadWeek() {
    const now = new Date();
    const labels = [];
    const temps = [];

    const weekdayNames = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"];

    for (let i = 6; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);

        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");

        const dayData = await loadHistory(`history/${y}/${m}/${da}`);
        const keys = Object.keys(dayData);

        if (keys.length > 0) {
            const last = dayData[keys[keys.length - 1]];
            temps.push(last.temperature);
        } else {
            temps.push(null);
        }

        labels.push(weekdayNames[d.getDay()]);
    }

    createChart("chart-week", labels, temps, "#4fc3f7", "today");
}

/* ‚≠ê MONAT */
async function loadMonth() {
    const now = new Date();
    const labels = [];
    const temps = [];

    for (let i = 29; i >= 0; i--) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);

        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");

        const dayData = await loadHistory(`history/${y}/${m}/${da}`);
        const keys = Object.keys(dayData);

        if (keys.length > 0) {
            const last = dayData[keys[keys.length - 1]];
            temps.push(last.temperature);
        } else {
            temps.push(null);
        }

        labels.push(da);
    }

    createChart("chart-month", labels, temps, "#81c784", "month");
}

/* ‚≠ê JAHR */
async function loadYear() {
    const now = new Date();
    const labels = ["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"];
    const temps = [];

    for (let month = 0; month < 12; month++) {
        const y = now.getFullYear();
        const m = String(month + 1).padStart(2, "0");

        const monthSnap = await get(ref(db, `history/${y}/${m}`));
        const monthData = monthSnap.val() || {};

        let lastTemp = null;

        Object.keys(monthData).forEach(day => {
            const entries = monthData[day];
            const keys = Object.keys(entries);
            if (keys.length > 0) {
                lastTemp = entries[keys[keys.length - 1]].temperature;
            }
        });

        temps.push(lastTemp);
    }

    createChart("chart-year", labels, temps, "#ba68c8", "auto");
}

/* ‚≠ê ALLES LADEN */
async function loadAll() {
    await loadToday();
    await loadWeek();
    await loadMonth();
    await loadYear();
}

loadAll();
setInterval(loadAll, 60000);

/* SERVICE WORKER */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js");
}

</script>

</body>
</html>




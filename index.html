<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Meine Wetterstation</title>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body { background:#111; color:#fff; font-family:Arial; }
  .hidden { display:none; }
  canvas { width:100%; max-height:300px; }
</style>
</head>

<body>

<h1>ðŸŒ¦ Meine Wetterstation</h1>

<div id="live-temp"></div>
<div id="live-hum"></div>
<div id="live-press"></div>
<div id="live-trend"></div>
<div id="live-icon"></div>
<div id="sunrise"></div>
<div id="sunset"></div>
<div id="minmax"></div>

<hr>

<button onclick="showTab('24h')">24h</button>
<button onclick="showTab('week')">Woche</button>
<button onclick="showTab('month')">Monat</button>
<button onclick="showTab('year')">Jahr</button>

<div id="24h"><canvas id="chart24h"></canvas></div>
<div id="week" class="hidden"><canvas id="chartWeek"></canvas></div>
<div id="month" class="hidden"><canvas id="chartMonth"></canvas></div>
<div id="year" class="hidden"><canvas id="chartYear"></canvas></div>

<h2>Radar</h2>
<div id="radar" style="height:300px;"></div>

<h2>Vorhersage</h2>
<div id="forecast"></div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "dummy",
  authDomain: "dummy",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dummy",
  storageBucket: "dummy",
  messagingSenderId: "dummy",
  appId: "dummy"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* Live-Werte */
const liveRef = firebase.database().ref("weather/live");
let lastTemp = null;

liveRef.on("value", (snap) => {
  const d = snap.val();
  if (!d) return;

  const t = d.temperature;

  document.getElementById("live-temp").textContent =
    "ðŸŒ¡ Temperatur: " + t.toFixed(1) + " Â°C";

  document.getElementById("live-hum").textContent =
    "ðŸ’§ Luftfeuchtigkeit: " + d.humidity.toFixed(1) + " %";

  document.getElementById("live-press").textContent =
    "ðŸŒ Luftdruck: " + d.pressure.toFixed(1) + " hPa";

  if (lastTemp !== null) {
    if (t > lastTemp) document.getElementById("live-trend").textContent = "ðŸ“ˆ Temperatur steigt";
    else if (t < lastTemp) document.getElementById("live-trend").textContent = "ðŸ“‰ Temperatur fÃ¤llt";
    else document.getElementById("live-trend").textContent = "âž¡ï¸ stabil";
  }
  lastTemp = t;

  /* OpenWeather optional */
  if (d.openweather && d.openweather.weather && d.openweather.weather[0]) {
    const ow = d.openweather;
    const w = ow.weather[0].main.toLowerCase();

    let icon = "â“";
    if (w.includes("clear")) icon = "â˜€ï¸";
    else if (w.includes("cloud")) icon = "â˜ï¸";
    else if (w.includes("rain")) icon = "ðŸŒ§ï¸";
    else if (w.includes("snow")) icon = "â„ï¸";

    document.getElementById("live-icon").textContent = icon;

    const sr = new Date(ow.sys.sunrise * 1000).toLocaleTimeString("de-DE", {
      hour: "2-digit", minute: "2-digit"
    });
    const ss = new Date(ow.sys.sunset * 1000).toLocaleTimeString("de-DE", {
      hour: "2-digit", minute: "2-digit"
    });

    document.getElementById("sunrise").textContent = "ðŸŒ… " + sr;
    document.getElementById("sunset").textContent = "ðŸŒ‡ " + ss;
  } else {
    document.getElementById("live-icon").textContent = "â”";
    document.getElementById("sunrise").textContent = "â€“";
    document.getElementById("sunset").textContent = "â€“";
  }
});

/* Min/Max */
async function updateMinMax() {
  const snap = await firebase.database().ref("weather/history/24h").get();
  const data = snap.val();
  if (!data) return;

  const temps = Object.values(data).map(v => v.t);
  const min = Math.min(...temps).toFixed(1);
  const max = Math.max(...temps).toFixed(1);

  document.getElementById("minmax").textContent =
    "Min/Max (24h): " + min + "Â°C / " + max + "Â°C";
}
setInterval(updateMinMax, 60000);
updateMinMax();

/* History */
async function loadHistory(path) {
  const snap = await firebase.database().ref(path).get();
  const data = snap.val();
  if (!data) return { labels: [], temps: [], hums: [], press: [] };

  const labels = [], temps = [], hums = [], press = [];

  for (const ts in data) {
    const d = new Date(ts * 1000);
    let label = "";

    if (path.includes("24h"))
      label = d.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });
    else if (path.includes("week"))
      label = d.toLocaleDateString("de-DE", { weekday: "short" }).replace(".", "");
    else if (path.includes("month"))
      label = d.toLocaleDateString("de-DE", { month: "short" }).replace(".", "");
    else if (path.includes("year"))
      label = d.getFullYear().toString();

    labels.push(label);
    temps.push(data[ts].t);
    hums.push(data[ts].h);
    press.push(data[ts].p);
  }

  return { labels, temps, hums, press };
}

/* Charts */
async function drawChart(canvasId, path, title) {
  const ctx = document.getElementById(canvasId).getContext("2d");
  const { labels, temps, hums, press } = await loadHistory(path);

  new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        { label:"Temperatur (Â°C)", data:temps, borderColor:"red", backgroundColor:"rgba(255,0,0,0.2)", tension:0.3 },
        { label:"Luftfeuchtigkeit (%)", data:hums, borderColor:"blue", backgroundColor:"rgba(0,0,255,0.2)", tension:0.3 },
        { label:"Luftdruck (hPa)", data:press, borderColor:"green", backgroundColor:"rgba(0,255,0,0.2)", tension:0.3 }
      ]
    }
  });
}

/* OpenWeather wieder aktiv */
async function updateOpenWeather() {
  const apiKey = "27602f1bbb8e3dd3587a1da6e3de24b6";
  const lat = 47.43599;
  const lon = 16.25597;

  const url =
    `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=de&appid=${apiKey}`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("OpenWeather Fehler");
    const data = await res.json();

    firebase.database().ref("weather/live/openweather").set(data);

  } catch (e) {
    console.error("OpenWeather lÃ¤dt nicht:", e);
  }
}
updateOpenWeather();
setInterval(updateOpenWeather, 10 * 60 * 1000);

/* Forecast */
async function loadForecast() {
  const snap = await firebase.database().ref("weather/live/openweather").get();
  const ow = snap.val();
  if (!ow) return;

  const lat = ow.coord.lat;
  const lon = ow.coord.lon;

  const url =
    `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=de&appid=27602f1bbb8e3dd3587a1da6e3de24b6`;

  const res = await fetch(url);
  const data = await res.json();

  const box = document.getElementById("forecast");
  box.innerHTML = "";

  data.list.slice(0, 10).forEach(item => {
    const d = new Date(item.dt * 1000);
    const div = document.createElement("div");
    div.innerHTML =
      `<b>${d.toLocaleString("de-DE")}</b><br>
       ðŸŒ¡ ${item.main.temp.toFixed(1)}Â°C<br>
       ðŸŒ¦ ${item.weather[0].description}<br><br>`;
    box.appendChild(div);
  });
}

/* Radar */
function initRadar() {
  const map = L.map('radar').setView([47.43599, 16.25597], 8);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  const rainLayer = L.tileLayer(
    `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=27602f1bbb8e3dd3587a1da6e3de24b6`,
    { opacity: 0.6 }
  ).addTo(map);
}

/* Tabs */
window.showTab = function(name) {
  document.getElementById("24h").classList.add("hidden");
  document.getElementById("week").classList.add("hidden");
  document.getElementById("month").classList.add("hidden");
  document.getElementById("year").classList.add("hidden");

  const tab = document.getElementById(name);
  tab.classList.remove("hidden");

  if (name === "24h") drawChart("chart24h", "weather/history/24h", "Letzte 24 Stunden");
  if (name === "week") drawChart("chartWeek", "weather/history/week", "Letzte 7 Tage");
  if (name === "month") drawChart("chartMonth", "weather/history/month", "Letzter Monat");
  if (name === "year") drawChart("chartYear", "weather/history/year", "Letztes Jahr");
};

/* Start */
window.onload = () => {
  drawChart("chart24h", "weather/history/24h", "Letzte 24 Stunden");
  drawChart("chartWeek", "weather/history/week", "Letzte 7 Tage");
  drawChart("chartMonth", "weather/history/month", "Letzter Monat");
  drawChart("chartYear", "weather/history/year", "Letztes Jahr");
  initRadar();
  loadForecast();
};
</script>

</body>
</html>

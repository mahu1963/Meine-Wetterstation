<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Wetterstation Stuben‚ÄëBernstein</title>

<!-- Wetter-Icon -->
<link rel="icon" type="image/png" href="https://openweathermap.org/img/wn/10d@2x.png">
<link rel="apple-touch-icon" href="https://openweathermap.org/img/wn/10d@2x.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin: 0;
    padding: 0;
    background: #0d0d0d;
    color: white;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
    font-size: 20px;
}
.main {
    padding: 30px 20px 40px;
    max-width: 1100px;
    margin: 0 auto;
}
/* Header */
#header {
    text-align: center;
    margin-bottom: 30px;
}
#header h1 {
    margin: 10px 0 0;
    font-size: 34px;
}
#header h3 {
    margin: 5px 0 10px;
    font-weight: 400;
    opacity: 0.8;
}
#gps, #sunrise, #sunset {
    opacity: 0.8;
    font-size: 18px;
    margin-top: 4px;
}
#live {
    margin-top: 12px;
    font-size: 22px;
    font-weight: 600;
    line-height: 1.4;
}
/* Tabs */
.tabs {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 14px;
    margin: 25px 0 10px;
}
.tab {
    padding: 16px 24px;
    border-radius: 14px;
    cursor: pointer;
    background: #1c1c1e;
    opacity: 0.7;
    transition: 0.2s;
    width: 90%;
    text-align: center;
    font-size: 22px;
}
.tab.active {
    background: #333;
    opacity: 1;
    font-weight: 600;
}
/* Sensor Buttons */
.sensor-buttons {
    display: flex;
    justify-content: center;
    gap: 18px;
    margin-bottom: 20px;
}
.sensor-btn {
    padding: 14px 22px;
    border-radius: 12px;
    background: #1c1c1e;
    cursor: pointer;
    opacity: 0.7;
    transition: 0.2s;
    font-size: 20px;
}
.sensor-btn.active {
    opacity: 1;
    font-weight: 600;
}
/* Chart */
.chart-box {
    background: #1c1c1e;
    padding: 20px;
    border-radius: 18px;
    margin-bottom: 30px;
}
#mainChart {
    height: 520px !important;
}
/* Radar */
#radar {
    background: #1c1c1e;
    padding: 10px;
    border-radius: 18px;
    margin-bottom: 30px;
}
#radar-frame {
    width: 100%;
    height: 420px;
    border: none;
    border-radius: 12px;
}
</style>
</head>
<body>

<div class="main">

    <div id="header">
        <img id="weather-icon" src="" style="width:140px;height:140px;">
        <h1>Stuben‚ÄëBernstein</h1>
        <h3>Martin Huber</h3>

        <div id="gps">GPS l√§dt‚Ä¶</div>
        <div id="sunrise"></div>
        <div id="sunset"></div>

        <!-- LIVE-WERT -->
        <div id="live">Live‚ÄëDaten werden geladen‚Ä¶</div>
    </div>

    <!-- Regenradar -->
    <div id="radar">
        <iframe
            id="radar-frame"
            src="https://www.rainviewer.com/map.html?loc=47.366,16.233,9&oFa=1&oC=1&oU=1&oCS=1&oF=1&oAP=1&c=3&o=83&lm=1&layer=radar&sm=1&sn=1"
            loading="lazy">
        </iframe>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-range="today">Heute</div>
        <div class="tab" data-range="week">Woche</div>
        <div class="tab" data-range="month">Monat</div>
        <div class="tab" data-range="year">Jahr</div>
    </div>

    <!-- Sensor Buttons -->
    <div class="sensor-buttons">
        <div class="sensor-btn active" data-sensor="temperature">Temperatur</div>
        <div class="sensor-btn" data-sensor="humidity">Feuchtigkeit</div>
        <div class="sensor-btn" data-sensor="pressure">Luftdruck</div>
    </div>

    <!-- Chart -->
    <div class="chart-box">
        <canvas id="mainChart"></canvas>
    </div>

</div>

<script type="module">
/* ================= FIREBASE INITIALISIERUNG ================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAfIU041dyNBiCC_ywpJiwf8mABJVsT-lw",
  authDomain: "meine-wetterstation.firebaseapp.com",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "meine-wetterstation",
  storageBucket: "meine-wetterstation.appspot.com",
  messagingSenderId: "593494014586",
  appId: "1:593494014586:web:a05ed68495b1b16d6059c3",
  measurementId: "G-ST9RCRW888"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

/* ================= LIVE-DATEN AUS FIREBASE ================= */

let lastTemp = null;
let lastHum  = null;
let lastPres = null;

function tempColor(t) {
    if (t <= -5) return "#4da3ff";
    if (t < 5)   return "#7fbfff";
    if (t < 15)  return "#a0ffb0";
    if (t < 25)  return "#ffe680";
    if (t < 30)  return "#ffb347";
    return "#ff5c5c";
}

onValue(ref(db, "/history/weather/temperature"), (snap) => {
    const temp = snap.val();
    if (temp == null) return;

    const liveEl = document.getElementById("live");
    liveEl.style.color = tempColor(temp);

    let arrow = "";
    if (lastTemp !== null) {
        if (temp > lastTemp) arrow = "‚ñ≤";
        else if (temp < lastTemp) arrow = "‚ñº";
        else arrow = "‚óè";
    }
    lastTemp = temp;

    liveEl.innerHTML = `üå°Ô∏è ${temp.toFixed(1)} ¬∞C ${arrow}`;
});

onValue(ref(db, "/history/weather/humidity"), (snap) => {
    const hum = snap.val();
    if (hum == null) return;

    const liveEl = document.getElementById("live");
    let txt = liveEl.innerHTML.split("<br>")[0];
    liveEl.innerHTML = `${txt}<br>üíß ${hum.toFixed(1)} %`;
    lastHum = hum;
});

onValue(ref(db, "/history/weather/pressure"), (snap) => {
    const pres = snap.val();
    if (pres == null) return;

    const liveEl = document.getElementById("live");
    const parts = liveEl.innerHTML.split("<br>");
    const first = parts[0] || "";
    const second = parts[1] || "";
    liveEl.innerHTML = `${first}<br>${second}<br>üß≠ ${pres.toFixed(1)} hPa`;
    lastPres = pres;
});

onValue(ref(db, "/history/weather/timestamp"), (snap) => {
    const t = snap.val();
    if (t == null) return;

    const dt = new Date(t * 1000).toLocaleString("de-AT");
    const liveEl = document.getElementById("live");
    const parts = liveEl.innerHTML.split("<br");
    const first = parts[0] || "";
    const second = parts[1] ? "<br" + parts[1] : "";
    const third  = parts[2] ? "<br" + parts[2] : "";

    liveEl.innerHTML = `${first}${second}${third}<br>‚è±Ô∏è ${dt}`;
});

/* ================= HISTORY / CHART ================= */

const ctx = document.getElementById("mainChart").getContext("2d");
let mainChart = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [{
            label: "Temperatur",
            data: [],
            borderColor: "#ffb347",
            backgroundColor: "rgba(255,179,71,0.2)",
            tension: 0.2,
            pointRadius: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { ticks: { color: "#ccc" }, grid: { color: "#333" } },
            y: { ticks: { color: "#ccc" }, grid: { color: "#333" } }
        },
        plugins: {
            legend: { labels: { color: "#fff" } }
        }
    }
});

/* ================= INIT ================= */
loadOpenWeather();
loadGPS();

</script>

</body>
</html>

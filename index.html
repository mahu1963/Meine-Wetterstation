<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Wetterstation Dashboard</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ------------------------------
   GLOBAL
--------------------------------*/
body {
    margin: 0;
    padding: 0;
    background: #121212;
    color: #eee;
    font-family: Arial, sans-serif;
    display: flex;
}

/* ------------------------------
   SIDEBAR (fixed, 180px)
--------------------------------*/
.sidebar {
    width: 180px;
    background: #1a1a1a;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    padding-top: 20px;
    box-shadow: 2px 0 10px #000;
    z-index: 1000;
}

.sidebar h2 {
    text-align: center;
    margin: 0;
    padding: 10px 0;
    font-size: 20px;
}

.sidebar button {
    width: 160px;
    margin: 10px;
    padding: 12px;
    background: #333;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
}

.sidebar button.active {
    background: #4fc3f7;
    color: #000;
}

/* Mobile: Sidebar collapses */
@media (max-width: 700px) {
    .sidebar {
        transform: translateX(-180px);
        transition: 0.3s;
    }
    .sidebar.open {
        transform: translateX(0);
    }
    .menu-btn {
        position: fixed;
        left: 10px;
        top: 10px;
        z-index: 2000;
        background: #4fc3f7;
        color: #000;
        padding: 10px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 18px;
    }
}

/* ------------------------------
   MAIN CONTENT
--------------------------------*/
.main {
    margin-left: 180px;
    padding: 20px;
    width: calc(100% - 180px);
}

@media (max-width: 700px) {
    .main {
        margin-left: 0;
        width: 100%;
    }
}

/* ------------------------------
   HEADER (GPS + Wettericon + Branding)
--------------------------------*/
.header {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.weather-icon {
    width: 70px;
    height: 70px;
}

.header-info {
    display: flex;
    flex-direction: column;
}

.header-info .title {
    font-size: 24px;
    font-weight: bold;
}

.header-info .subtitle {
    font-size: 18px;
    color: #ccc;
}

.header-info .gps {
    font-size: 14px;
    color: #aaa;
}

.header-info .datetime {
    font-size: 14px;
    color: #aaa;
}

/* ------------------------------
   LIVE-WERTE
--------------------------------*/
.cards {
    display: flex;
    gap: 20px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.card {
    background: #1e1e1e;
    padding: 20px;
    border-radius: 12px;
    width: 200px;
    text-align: center;
    box-shadow: 0 0 10px #000;
}

.value {
    font-size: 32px;
    margin-top: 10px;
    color: #4fc3f7;
}

.trend {
    font-size: 26px;
    margin-top: 5px;
}

/* ------------------------------
   DIAGRAMM-TABS
--------------------------------*/
.chart-tabs {
    margin-top: 20px;
    text-align: center;
}

.chart-tab {
    background: #222;
    padding: 10px 15px;
    margin: 5px;
    border-radius: 6px;
    cursor: pointer;
    display: inline-block;
}

.chart-tab.active {
    background: #4fc3f7;
    color: #000;
}

/* ------------------------------
   CHART
--------------------------------*/
#chart-container {
    width: 95%;
    margin: auto;
    padding-bottom: 40px;
}

.minmax {
    text-align: center;
    margin-top: 10px;
    font-size: 18px;
    color: #bbb;
}

/* ------------------------------
   SVG ICONS (SF SYMBOLS)
--------------------------------*/

/* Sonne */
.sun {
    fill: #ffeb3b;
}

/* Wolke */
.cloud {
    fill: #ccc;
}

/* Regen */
.rain {
    fill: #4fc3f7;
}

/* Schnee */
.snow {
    fill: #fff;
}

/* Blitz */
.bolt {
    fill: #ff9800;
}

/* Nebel */
.fog {
    fill: #aaa;
}

/* Trendpfeile */
.arrow-up {
    fill: red;
}
.arrow-down {
    fill: #4fc3f7;
}
</style>
</head>
<body>

<!-- Mobile MenÃ¼ Button -->
<div class="menu-btn" onclick="toggleSidebar()">â˜° MenÃ¼</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
    <h2>Navigation</h2>
    <button onclick="setMode('today')" id="btn-today">Heute</button>
    <button onclick="setMode('week')" id="btn-week">Woche</button>
    <button onclick="setMode('month')" id="btn-month">Monat</button>
    <button onclick="setMode('year')" id="btn-year">Jahr</button>
</div>

<!-- MAIN CONTENT -->
<div class="main">

    <!-- HEADER -->
    <div class="header">
        <!-- Wetter Icon -->
        <svg id="weatherIcon" class="weather-icon" viewBox="0 0 100 100"></svg>

        <!-- Branding + GPS + Datum -->
        <div class="header-info">
            <div class="title">Stubenâ€‘Bernstein</div>
            <div class="subtitle">Martin Huber</div>
            <div class="gps" id="gps">GPS wird geladenâ€¦</div>
            <div class="datetime" id="datetime">--:--:--</div>
        </div>
    </div>

    <!-- LIVE-WERTE -->
    <div class="cards">
        <div class="card">
            ðŸŒ¡ Temperatur
            <div class="value" id="temp">--</div>
            <div class="trend" id="trend-temp"></div>
        </div>

        <div class="card">
            ðŸ’§ Feuchte
            <div class="value" id="hum">--</div>
            <div class="trend" id="trend-hum"></div>
        </div>

        <div class="card">
            ðŸŒ¬ Druck
            <div class="value" id="pres">--</div>
            <div class="trend" id="trend-pres"></div>
        </div>
    </div>

    <!-- DIAGRAMM-TABS -->
    <div class="chart-tabs">
        <span class="chart-tab active" id="tab-temp" onclick="setChartType('temp')">Temperatur</span>
        <span class="chart-tab" id="tab-hum" onclick="setChartType('hum')">Feuchte</span>
        <span class="chart-tab" id="tab-pres" onclick="setChartType('pres')">Druck</span>
    </div>

    <!-- MIN/MAX -->
    <div class="minmax" id="minmax">Min/Max wird geladenâ€¦</div>

    <!-- CHART -->
    <div id="chart-container">
        <canvas id="chart"></canvas>
    </div>

</div> <!-- END MAIN -->
<script>
// ------------------------------------------------------------
// SIDEBAR (Mobile)
// ------------------------------------------------------------
function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("open");
}

// ------------------------------------------------------------
// DATUM + UHRZEIT
// ------------------------------------------------------------
function updateDateTime() {
    const now = new Date();
    const d = now.toLocaleDateString("de-DE");
    const t = now.toLocaleTimeString("de-DE");
    document.getElementById("datetime").innerText = `${d} ${t}`;
}
setInterval(updateDateTime, 1000);
updateDateTime();

// ------------------------------------------------------------
// GPS (Browser)
// ------------------------------------------------------------
function loadGPS() {
    if (!navigator.geolocation) {
        document.getElementById("gps").innerText = "GPS nicht verfÃ¼gbar";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude.toFixed(5);
            const lon = pos.coords.longitude.toFixed(5);
            document.getElementById("gps").innerText = `GPS: ${lat}, ${lon}`;
        },
        () => {
            document.getElementById("gps").innerText = "GPS deaktiviert";
        }
    );
}
loadGPS();

// ------------------------------------------------------------
// FIREBASE CONFIG
// ------------------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyAfIU041dyNBiCC_ywpJiwf8mABJVsT-lw",
  authDomain: "meine-wetterstation.firebaseapp.com",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "meine-wetterstation",
  storageBucket: "meine-wetterstation.appspot.com",
  messagingSenderId: "593494014586",
  appId: "1:593494014586:web:a05ed68495b1b16d6059c3",
  measurementId: "G-ST9RCRW888"
};

firebase.initializeApp(firebaseConfig);

// ------------------------------------------------------------
// WETTER ICON (SF SYMBOLS als SVG)
// ------------------------------------------------------------
function setWeatherIcon(temp, hum, pres) {
    const icon = document.getElementById("weatherIcon");

    let svg = "";

    if (temp > 25 && hum < 60) {
        svg = `<circle cx="50" cy="50" r="25" class="sun"/>`;
    } else if (hum > 80 && temp > 0) {
        svg = `<ellipse cx="50" cy="60" rx="30" ry="18" class="cloud"/>
               <line x1="40" y1="75" x2="40" y2="90" class="rain" stroke-width="4"/>
               <line x1="60" y1="75" x2="60" y2="90" class="rain" stroke-width="4"/>`;
    } else if (temp < 0) {
        svg = `<ellipse cx="50" cy="60" rx="30" ry="18" class="cloud"/>
               <circle cx="40" cy="80" r="4" class="snow"/>
               <circle cx="60" cy="80" r="4" class="snow"/>`;
    } else if (pres < 990) {
        svg = `<ellipse cx="50" cy="60" rx="30" ry="18" class="cloud"/>
               <polygon points="45,75 55,75 50,90" class="bolt"/>`;
    } else if (hum > 90) {
        svg = `<rect x="20" y="50" width="60" height="20" class="fog"/>`;
    } else if (hum > 60) {
        svg = `<ellipse cx="50" cy="60" rx="30" ry="18" class="cloud"/>`;
    } else {
        svg = `<circle cx="50" cy="50" r="25" class="sun"/>`;
    }

    icon.innerHTML = svg;
}

// ------------------------------------------------------------
// TRENDPFEILE
// ------------------------------------------------------------
let lastTemp = null;
let lastHum = null;
let lastPres = null;

function updateTrend(id, last, current) {
    const el = document.getElementById(id);

    if (last === null) {
        el.innerHTML = "";
        return current;
    }

    if (current > last) {
        el.innerHTML = `<svg width="24" height="24"><polygon points="12,4 20,20 4,20" class="arrow-up"/></svg>`;
    } else if (current < last) {
        el.innerHTML = `<svg width="24" height="24"><polygon points="12,20 20,4 4,4" class="arrow-down"/></svg>`;
    } else {
        el.innerHTML = "";
    }

    return current;
}

// ------------------------------------------------------------
// LIVE-WERTE
// ------------------------------------------------------------
firebase.database().ref("weather").on("value", snap => {
    const d = snap.val();
    if (!d) return;

    const t = d.temperature;
    const h = d.humidity;
    const p = d.pressure;

    document.getElementById("temp").innerText = t.toFixed(1);
    document.getElementById("hum").innerText  = h.toFixed(1);
    document.getElementById("pres").innerText = p.toFixed(1);

    lastTemp = updateTrend("trend-temp", lastTemp, t);
    lastHum  = updateTrend("trend-hum",  lastHum,  h);
    lastPres = updateTrend("trend-pres", lastPres, p);

    setWeatherIcon(t, h, p);
});

// ------------------------------------------------------------
// HISTORY LADEN
// ------------------------------------------------------------
function loadHistoryPath(path, callback) {
    firebase.database().ref(path).once("value", snapshot => {
        const data = snapshot.val();
        if (!data) {
            callback([], [], [], []);
            return;
        }

        const times = [];
        const temps = [];
        const hums = [];
        const press = [];

        const keys = Object.keys(data).sort();

        keys.forEach(key => {
            if (key === "0000") {
                times.length = 0;
                temps.length = 0;
                hums.length = 0;
                press.length = 0;
            }

            const entry = data[key];
            if (!entry) return;

            times.push(key);
            temps.push(entry.temperature);
            hums.push(entry.humidity);
            press.push(entry.pressure);
        });

        callback(times, temps, hums, press);
    });
}

// ------------------------------------------------------------
// CHART
// ------------------------------------------------------------
let chart;
let chartType = "temp";

function setChartType(type) {
    chartType = type;

    document.querySelectorAll(".chart-tab").forEach(t => t.classList.remove("active"));
    document.getElementById(`tab-${type}`).classList.add("active");

    loadMode();
}

function updateChart(times, temps, hums, press) {
    const ctx = document.getElementById("chart").getContext("2d");

    if (chart) chart.destroy();

    let dataset;
    let color;

    if (chartType === "temp") {
        dataset = temps;
        color = "#ff9800";
    } else if (chartType === "hum") {
        dataset = hums;
        color = "#4fc3f7";
    } else {
        dataset = press;
        color = "#81c784";
    }

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: times,
            datasets: [
                {
                    label: chartType === "temp" ? "Temperatur (Â°C)" :
                           chartType === "hum"  ? "Feuchte (%)" :
                                                  "Druck (hPa)",
                    data: dataset,
                    borderColor: color,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            animation: false
        }
    });

    updateMinMax(temps, hums, press);
}

// ------------------------------------------------------------
// MIN/MAX
// ------------------------------------------------------------
function updateMinMax(temps, hums, press) {
    if (temps.length === 0) {
        document.getElementById("minmax").innerText = "Keine Daten";
        return;
    }

    const tMin = Math.min(...temps).toFixed(1);
    const tMax = Math.max(...temps).toFixed(1);

    const hMin = Math.min(...hums).toFixed(1);
    const hMax = Math.max(...hums).toFixed(1);

    const pMin = Math.min(...press).toFixed(1);
    const pMax = Math.max(...press).toFixed(1);

    document.getElementById("minmax").innerText =
        `Temp: ${tMin}Â°C â€“ ${tMax}Â°C | Feuchte: ${hMin}% â€“ ${hMax}% | Druck: ${pMin} â€“ ${pMax} hPa`;
}

// ------------------------------------------------------------
// ZEITRÃ„UME
// ------------------------------------------------------------
function loadTodayHistory() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");

    loadHistoryPath(`history/${y}/${m}/${d}`, updateChart);
}

function loadRange(daysBack, callback) {
    const now = new Date();
    const promises = [];

    for (let i = 0; i < daysBack; i++) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);

        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");

        const path = `history/${y}/${m}/${da}`;

        promises.push(
            new Promise(resolve => {
                loadHistoryPath(path, (t, te, h, p) => resolve({ t, te, h, p }));
            })
        );
    }

    Promise.all(promises).then(days => {
        const times = [], temps = [], hums = [], press = [];

        days.reverse().forEach(day => {
            day.t.forEach((time, i) => {
                times.push(time);
                temps.push(day.te[i]);
                hums.push(day.h[i]);
                press.push(day.p[i]);
            });
        });

        callback(times, temps, hums, press);
    });
}

function loadWeekHistory()  { loadRange(7,  updateChart); }
function loadMonthHistory() { loadRange(30, updateChart); }
function loadYearHistory()  { loadRange(365, updateChart); }

// ------------------------------------------------------------
// BUTTON-AKTIVIERUNG + AUTO-REFRESH
// ------------------------------------------------------------
let currentMode = "today";
let refreshTimer;

function setMode(mode) {
    currentMode = mode;

    document.querySelectorAll(".sidebar button").forEach(btn => btn.classList.remove("active"));
    document.getElementById(`btn-${mode}`).classList.add("active");

    loadMode();
}

function loadMode() {
    if (refreshTimer) clearInterval(refreshTimer);

    if (currentMode === "today") loadTodayHistory();
    if (currentMode === "week")  loadWeekHistory();
    if (currentMode === "month") loadMonthHistory();
    if (currentMode === "year")  loadYearHistory();

    refreshTimer = setInterval(loadMode, 60000);
}

// ------------------------------------------------------------
// START
// ------------------------------------------------------------
setMode("today");

</script>
</body>
</html>

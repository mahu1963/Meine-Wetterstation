<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Wetterstation Stuben‑Bernstein</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin: 0;
    padding: 0;
    background: #0d0d0d;
    color: white;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
}

.main {
    padding: 30px 20px 40px;
    max-width: 1100px;
    margin: 0 auto;
}

/* Header */
#header {
    text-align: center;
    margin-bottom: 30px;
}

#header h1 {
    margin: 10px 0 0;
    font-size: 28px;
}

#header h3 {
    margin: 5px 0 10px;
    font-weight: 400;
    opacity: 0.8;
}

#gps {
    opacity: 0.7;
    font-size: 15px;
}

/* Tabs */
.tabs {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 25px 0 10px;
}

.tab {
    padding: 10px 18px;
    border-radius: 12px;
    cursor: pointer;
    background: #1c1c1e;
    opacity: 0.7;
    transition: 0.2s;
}

.tab.active {
    background: #333;
    opacity: 1;
    font-weight: 600;
}

/* Sensor Buttons */
.sensor-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
}

.sensor-btn {
    padding: 8px 16px;
    border-radius: 10px;
    background: #1c1c1e;
    cursor: pointer;
    opacity: 0.7;
    transition: 0.2s;
}

.sensor-btn.active {
    opacity: 1;
    font-weight: 600;
}

/* Chart Container */
.chart-box {
    background: #1c1c1e;
    padding: 20px;
    border-radius: 18px;
}
</style>
</head>
<body>

<div class="main">

    <div id="header">
        <img id="weather-icon" src="" style="width:120px;height:120px;">
        <h1>Stuben‑Bernstein</h1>
        <h3>Martin Huber</h3>
        <div id="gps">GPS lädt…</div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-range="today">Heute</div>
        <div class="tab" data-range="week">Woche</div>
        <div class="tab" data-range="month">Monat</div>
        <div class="tab" data-range="year">Jahr</div>
    </div>

    <!-- Sensor Buttons -->
    <div class="sensor-buttons">
        <div class="sensor-btn active" data-sensor="temperature">Temperatur</div>
        <div class="sensor-btn" data-sensor="humidity">Feuchtigkeit</div>
        <div class="sensor-btn" data-sensor="pressure">Luftdruck</div>
    </div>

    <!-- Chart -->
    <div class="chart-box">
        <canvas id="mainChart"></canvas>
    </div>

  <script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, get }
    from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAfIU041dyNBiCC_ywpJiwf8mABJVsT-lw",
  authDomain: "meine-wetterstation.firebaseapp.com",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "meine-wetterstation",
  storageBucket: "meine-wetterstation.appspot.com",
  messagingSenderId: "593494014586",
  appId: "1:593494014586:web:a05ed68495b1b16d6059c3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ================= OPENWEATHER ================= */
const OWM_API_KEY = "DEIN_OWM_API_KEY_HIER";  /* <--- HIER EINTRAGEN */
const LAT = 47.366;
const LON = 16.233;

async function loadOpenWeather() {
    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${LAT}&lon=${LON}&units=metric&lang=de&appid=${OWM_API_KEY}&_=${Date.now()}`;
        const res = await fetch(url);

        if (!res.ok) return;

        const data = await res.json();

        if (data.weather && data.weather[0].icon) {
            document.getElementById("weather-icon").src =
                `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
        }
    } catch (e) {}
}

/* ================= GPS ================= */
function loadGPS() {
    if (!navigator.geolocation) return;

    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude.toFixed(5);
        const lon = pos.coords.longitude.toFixed(5);
        document.getElementById("gps").innerText = `GPS: ${lat}, ${lon}`;
    });
}

/* ================= LIVE-WERTE ================= */
onValue(ref(db, "weather"), snap => {
    const d = snap.val();
    if (!d) return;
});
/* ================= HISTORY LADEN ================= */
async function loadHistory(sensor) {
    const year = new Date().getFullYear();
    const snap = await get(ref(db, `history/${year}/${sensor}`));
    return snap.val() || {};
}

/* ================= FILTER ================= */
function filterData(data, hours) {
    const now = Date.now();
    const limit = now - hours * 3600 * 1000;

    const timestamps = Object.keys(data)
        .map(t => Number(t) * 1000)
        .filter(t => t >= limit)
        .sort((a, b) => a - b);

    return timestamps.map(t => ({
        time: new Date(t).toLocaleTimeString("de-AT", { hour: "2-digit", minute: "2-digit" }),
        value: data[Math.floor(t / 1000)]
    }));
}

/* ================= CHART ================= */
let chart;

function drawChart(labels, values, color) {
    if (chart) chart.destroy();

    const ctx = document.getElementById("mainChart").getContext("2d");

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [{
                data: values,
                borderColor: color,
                backgroundColor: color,
                tension: 0.35,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            animation: false,
            plugins: { legend: { display: false } }
        }
    });
}

/* ================= STEUERUNG ================= */
const sensorColors = {
    temperature: "#fdd835",
    humidity: "#00e5ff",
    pressure: "#e040fb"
};

let currentSensor = "temperature";
let currentRange = "today";

async function updateChart() {
    const data = await loadHistory(currentSensor);

    let filtered;

    if (currentRange === "today") filtered = filterData(data, 24);
    if (currentRange === "week")  filtered = filterData(data, 24 * 7);
    if (currentRange === "month") filtered = filterData(data, 24 * 30);
    if (currentRange === "year") {
        const timestamps = Object.keys(data).map(t => Number(t) * 1000).sort((a,b)=>a-b);
        filtered = timestamps.map(t => ({
            time: new Date(t).toLocaleDateString("de-AT"),
            value: data[Math.floor(t / 1000)]
        }));
    }

    drawChart(
        filtered.map(x => x.time),
        filtered.map(x => x.value),
        sensorColors[currentSensor]
    );
}

/* ================= EVENTS ================= */
document.querySelectorAll(".tab").forEach(tab => {
    tab.onclick = () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        currentRange = tab.dataset.range;
        updateChart();
    };
});

document.querySelectorAll(".sensor-btn").forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll(".sensor-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentSensor = btn.dataset.sensor;
        updateChart();
    };
});

/* ================= START ================= */
loadGPS();
loadOpenWeather();
updateChart();
setInterval(loadOpenWeather, 60000);
</script>

</body>
</html>      

<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>ESP32 Wetterstation</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    margin: 0;
    padding: 20px;
  }
  h1 { margin-top: 0; }
  .card {
    background: white;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  canvas {
    width: 100%;
    height: 300px;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>ESP32 Wetterstation</h1>

<div class="card">
  <h2>Aktuelle Werte</h2>
  <p><b>Temperatur:</b> <span id="t">--</span> °C</p>
  <p><b>Luftfeuchtigkeit:</b> <span id="h">--</span> %</p>
  <p><b>Luftdruck:</b> <span id="p">--</span> hPa</p>
</div>

<div class="card">
  <h2>Verlauf – letzte 24 Stunden</h2>
  <canvas id="chart24"></canvas>
</div>

<script>
let ws;
let chart24;

// -------------------------------
// WebSocket verbinden
// -------------------------------
function connectWS() {
  ws = new WebSocket("ws://" + location.hostname + "/ws");

  ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    updateUI(data);
  };

  ws.onclose = () => {
    setTimeout(connectWS, 2000);
  };
}

connectWS();

// -------------------------------
// UI aktualisieren
// -------------------------------
function updateUI(data) {
  document.getElementById("t").textContent = data.current.temperature.toFixed(1);
  document.getElementById("h").textContent = data.current.humidity.toFixed(1);
  document.getElementById("p").textContent = data.current.pressure.toFixed(1);

  updateChart24(data.history.last24h);
}

// -------------------------------
// Chart initialisieren
// -------------------------------
function initChart() {
  const ctx = document.getElementById("chart24").getContext("2d");

  chart24 = new Chart(ctx, {
    type: "line",
    data: {
      labels: [],
      datasets: [
        {
          label: "Temperatur (°C)",
          data: [],
          borderColor: "red",
          fill: false
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { display: false },
        y: { beginAtZero: false }
      }
    }
  });
}

initChart();

// -------------------------------
// Chart aktualisieren
// -------------------------------
function updateChart24(arr) {
  const labels = arr.map(e => new Date(e.time * 1000).toLocaleTimeString());
  const temps  = arr.map(e => e.temperature);

  chart24.data.labels = labels;
  chart24.data.datasets[0].data = temps;
  chart24.update();
}
</script>

</body>
</html>

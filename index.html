<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Wetterstation</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ----------------------------------------------------
   GLOBAL STYLE (Dark Mode + iOS Look)
---------------------------------------------------- */
body {
    margin: 0;
    padding: 0;
    background: #0d0d0d;
    color: white;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Arial, sans-serif;
}

/* Layout */
.main {
    padding: 40px;
    padding-top: calc(40px + env(safe-area-inset-top));
}

/* Header */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.weather-icon {
    width: 120px;
    height: 120px;
}

.header-info .title {
    font-size: 36px;
    font-weight: 700;
    letter-spacing: -0.5px;
}

.header-info .subtitle {
    font-size: 22px;
    opacity: 0.8;
}

.header-info .gps,
.header-info .datetime {
    font-size: 18px;
    opacity: 0.7;
}

/* Cards */
.cards {
    display: flex;
    gap: 30px;
    margin-top: 30px;
}

.card {
    flex: 1;
    background: #1c1c1e;
    padding: 30px;
    border-radius: 22px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
}

.card .label {
    font-size: 20px;
    opacity: 0.8;
}

.card .value {
    font-size: 48px;
    font-weight: 600;
    margin-top: 10px;
}

.trend svg {
    width: 32px;
    height: 32px;
}

/* Tabs */
.chart-tabs {
    margin-top: 30px;
}

.chart-tab {
    background: #2c2c2e;
    padding: 14px 22px;
    border-radius: 14px;
    font-size: 20px;
    margin: 6px;
    display: inline-block;
    transition: 0.2s;
}

.chart-tab.active {
    background: #0a84ff;
    color: white;
    font-weight: 600;
}

/* Chart */
#chart-container {
    margin-top: 25px;
}

/* Min/Max */
.minmax {
    font-size: 20px;
    margin-top: 15px;
    opacity: 0.8;
}

/* Sidebar */
.sidebar {
    position: fixed;
    left: -260px;
    top: 0;
    width: 240px;
    height: 100%;
    background: #1c1c1e;
    padding-top: 60px;
    box-shadow: 4px 0 20px rgba(0,0,0,0.4);
    transition: 0.3s;
}

.sidebar.open {
    left: 0;
}

.sidebar button {
    width: 200px;
    margin: 10px auto;
    display: block;
    padding: 18px;
    font-size: 20px;
    border-radius: 14px;
    background: #2c2c2e;
    color: white;
    border: none;
}

.sidebar button.active {
    background: #0a84ff;
}

.menu-btn {
    position: fixed;
    left: 20px;
    top: calc(20px + env(safe-area-inset-top));
    background: #0a84ff;
    color: white;
    padding: 12px 18px;
    border-radius: 12px;
    font-size: 22px;
    border: none;
    z-index: 1000;
}
.weather-icon {
    font-size: 90px;     /* Emoji sichtbar machen */
    line-height: 1;      /* Kein zus√§tzlicher Abstand */
    width: auto;         /* SVG-Gr√∂√üe entfernen */
    height: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}
   
/* ----------------------------------------------------
   MOBILE iOS OPTIMIERUNG
---------------------------------------------------- */
@media (max-width: 700px) {

    body {
        font-size: 19px;
        line-height: 1.45;
    }

    .main {
        padding: 25px;
        padding-top: calc(25px + env(safe-area-inset-top));
    }

    .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    .weather-icon {
        width: 90px;
        height: 90px;
    }

    .header-info .title {
        font-size: 32px;
    }

    .cards {
        flex-direction: column;
        gap: 25px;
    }

    .card {
        width: 100%;
        padding: 28px;
    }

    .card .value {
        font-size: 44px;
    }

    .chart-tab {
        font-size: 20px;
        padding: 14px 20px;
    }

    .sidebar {
        width: 240px;
    }

    .sidebar button {
        font-size: 20px;
        padding: 18px;
    }
}
</style>
</head>

<body>

<button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>

<div class="sidebar" id="sidebar">
    <button id="btn-today" onclick="setMode('today')">Heute</button>
    <button id="btn-week" onclick="setMode('week')">Woche</button>
    <button id="btn-month" onclick="setMode('month')">Monat</button>
    <button id="btn-year" onclick="setMode('year')">Jahr</button>
</div>

<div class="main">

    <div class="header">
    <div id="weatherIcon" class="weather-icon">‚õÖ</div>

    <div class="header-info">
        <div class="title">Stuben‚ÄëBernstein</div>
        <div class="subtitle">Martin Huber</div>
        <div class="gps" id="gps">GPS l√§dt‚Ä¶</div>
        <div class="datetime" id="datetime">--:--</div>
    </div>
</div>

    <div class="cards">
        <div class="card">
            <div class="label">Temperatur</div>
            <div class="value" id="temp">--</div>
            <div class="trend" id="trend-temp"></div>
        </div>

        <div class="card">
            <div class="label">Feuchtigkeit</div>
            <div class="value" id="hum">--</div>
            <div class="trend" id="trend-hum"></div>
        </div>

        <div class="card">
            <div class="label">Luftdruck</div>
            <div class="value" id="pres">--</div>
            <div class="trend" id="trend-pres"></div>
        </div>
    </div>

    <div class="chart-tabs">
        <span class="chart-tab active" id="tab-temp" onclick="setChartType('temp')">Temperatur</span>
        <span class="chart-tab" id="tab-hum" onclick="setChartType('hum')">Feuchte</span>
        <span class="chart-tab" id="tab-pres" onclick="setChartType('pres')">Druck</span>
    </div>

    <div id="chart-container">
        <canvas id="chart"></canvas>
    </div>

    <div class="minmax" id="minmax">Min/Max l√§dt‚Ä¶</div>

</div>

<!-- ----------------------------------------------------
     JAVASCRIPT ‚Äì FIREBASE SDK 9
---------------------------------------------------- -->
<script type="module">

/* Firebase SDK 9 */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, get }
    from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

/* Firebase-Konfiguration */
const firebaseConfig = {
  apiKey: "AIzaSyAfIU041dyNBiCC_ywpJiwf8mABJVsT-lw",
  authDomain: "meine-wetterstation.firebaseapp.com",
  databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "meine-wetterstation",
  storageBucket: "meine-wetterstation.appspot.com",
  messagingSenderId: "593494014586",
  appId: "1:593494014586:web:a05ed68495b1b16d6059c3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Sidebar */
window.toggleSidebar = function () {
    document.getElementById("sidebar").classList.toggle("open");
};

/* Datum & Uhrzeit */
function updateDateTime() {
    const now = new Date();
    document.getElementById("datetime").innerText =
        now.toLocaleDateString("de-DE") + " " + now.toLocaleTimeString("de-DE");
}
setInterval(updateDateTime, 1000);
updateDateTime();

/* GPS */
function loadGPS() {
    if (!navigator.geolocation) {
        document.getElementById("gps").innerText = "GPS nicht verf√ºgbar";
        return;
    }
    navigator.geolocation.getCurrentPosition(
        pos => {
            document.getElementById("gps").innerText =
                `GPS: ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
        },
        () => document.getElementById("gps").innerText = "GPS deaktiviert"
    );
}
loadGPS();

/* Wetter-Icon automatisch */
function updateWeatherIcon(temp, hum, pres) {
    const icon = document.getElementById("weatherIcon");

    if (pres < 990)       icon.innerHTML = "üåßÔ∏è";   // Regen
    else if (hum > 85)    icon.innerHTML = "‚òÅÔ∏è";   // Wolkig
    else if (temp < 0)    icon.innerHTML = "‚ùÑÔ∏è";   // Schnee
    else if (temp > 25)   icon.innerHTML = "‚òÄÔ∏è";   // Sonne
    else                  icon.innerHTML = "‚õÖ";   // Sonne + Wolken
}

/* Trendpfeile mit Toleranz */
let lastTemp = null, lastHum = null, lastPres = null;

function updateTrend(id, last, current) {
    const el = document.getElementById(id);

    if (last === null) {
        el.innerHTML = "";
        return current;
    }

    const diff = current - last;

    if (Math.abs(diff) < 0.05) {
        el.innerHTML = "";
    } else if (diff > 0) {
        el.innerHTML = `<svg width="24" height="24"><polygon points="12,4 20,20 4,20" fill="#4fc3f7"/></svg>`;
    } else {
        el.innerHTML = `<svg width="24" height="24"><polygon points="12,20 20,4 4,4" fill="#ff5252"/></svg>`;
    }

    return current;
}

/* LIVE-DATEN */
onValue(ref(db, "weather"), snap => {
    const d = snap.val();
    if (!d) return;

    document.getElementById("temp").innerText = d.temperature.toFixed(1);
    document.getElementById("hum").innerText = d.humidity.toFixed(1);
    document.getElementById("pres").innerText = d.pressure.toFixed(1);

    lastTemp = updateTrend("trend-temp", lastTemp, d.temperature);
    lastHum  = updateTrend("trend-hum", lastHum, d.humidity);
    lastPres = updateTrend("trend-pres", lastPres, d.pressure);

    updateWeatherIcon(d.temperature, d.humidity, d.pressure);
});

/* CHARTS */
let chart;
let chartType = "temp";

window.setChartType = function(type) {
    chartType = type;
    document.querySelectorAll(".chart-tab").forEach(t => t.classList.remove("active"));
    document.getElementById(`tab-${type}`).classList.add("active");
    loadMode();
};

function updateChart(times, temps, hums, press) {
    const ctx = document.getElementById("chart").getContext("2d");
    if (chart) chart.destroy();

    let data, color;
    if (chartType === "temp") { data = temps; color = "#ff9800"; }
    else if (chartType === "hum") { data = hums; color = "#4fc3f7"; }
    else { data = press; color = "#81c784"; }

    chart = new Chart(ctx, {
        type: "line",
        data: { labels: times, datasets: [{ data, borderColor: color, fill: false }] },
        options: { responsive: true, animation: false }
    });

    updateMinMax(temps, hums, press);
}

function updateMinMax(temps, hums, press) {
    if (temps.length === 0) {
        document.getElementById("minmax").innerText = "Keine Daten";
        return;
    }
    document.getElementById("minmax").innerText =
        `Temp: ${Math.min(...temps).toFixed(1)} ‚Äì ${Math.max(...temps).toFixed(1)} ¬∞C | ` +
        `Feuchte: ${Math.min(...hums).toFixed(1)} ‚Äì ${Math.max(...hums).toFixed(1)} % | ` +
        `Druck: ${Math.min(...press).toFixed(1)} ‚Äì ${Math.max(...press).toFixed(1)} hPa`;
}

/* HISTORY ‚Äì FIX f√ºr deinen ESP32 */
async function loadHistoryPath(path, cb) {
    const snap = await get(ref(db, path));
    const data = snap.val();

    if (!data) {
        cb([], [], [], []);
        return;
    }

    const times = [], temps = [], hums = [], press = [];
    const keys = Object.keys(data).sort();

    keys.forEach(k => {
        const e = data[k];
        if (!e) return;
        times.push(k);
        temps.push(e.temperature);
        hums.push(e.humidity);
        press.push(e.pressure);
    });

    cb(times, temps, hums, press);
}

function loadTodayHistory() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    loadHistoryPath(`history/${y}/${m}/${da}`, updateChart);
}

async function loadRange(days, cb) {
    const now = new Date();
    const promises = [];

    for (let i = 0; i < days; i++) {
        const d = new Date(now);
        d.setDate(now.getDate() - i);

        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const da = String(d.getDate()).padStart(2, "0");

        promises.push(loadHistoryPath(`history/${y}/${m}/${da}`, () => {}));
    }

    const results = await Promise.all(promises);

    const times = [], temps = [], hums = [], press = [];

    results.forEach(r => {
        r[0].forEach((t, i) => {
            times.push(t);
            temps.push(r[1][i]);
            hums.push(r[2][i]);
            press.push(r[3][i]);
        });
    });

    cb(times, temps, hums, press);
}

function loadWeekHistory()  { loadRange(7, updateChart); }
function loadMonthHistory() { loadRange(30, updateChart); }
function loadYearHistory()  { loadRange(365, updateChart); }

/* MODUS */
let currentMode = "today";
let refreshTimer;

window.setMode = function(mode) {
    currentMode = mode;
    document.querySelectorAll(".sidebar button").forEach(b => b.classList.remove("active"));
    document.getElementById(`btn-${mode}`).classList.add("active");
    loadMode();
};

function loadMode() {
    if (refreshTimer) clearInterval(refreshTimer);

    if (currentMode === "today") loadTodayHistory();
    if (currentMode === "week")  loadWeekHistory();
    if (currentMode === "month") loadMonthHistory();
    if (currentMode === "year")  loadYearHistory();

    refreshTimer = setInterval(loadMode, 60000);
}

setMode("today");

</script>

</body>
</html>




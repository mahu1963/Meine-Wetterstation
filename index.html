<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Meine Wetterstation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #eef2f7;
            margin: 0;
            padding: 20px;
        }
        .card {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px #0002;
        }
        .value {
            font-size: 2.2rem;
            font-weight: bold;
        }
        .trend {
            margin-left: 10px;
            font-size: 1.4rem;
        }
        #weatherIcon {
            font-size: 3rem;
            margin-top: 10px;
        }
    </style>
</head>

<body>

<h1>ğŸŒ¤ï¸ Meine Wetterstation</h1>

<div class="card">
    <div>Temperatur: <span id="temp" class="value">â€“</span> Â°C
        <i id="tempTrend" class="trend"></i>
    </div>
    <div>Feuchte: <span id="hum" class="value">â€“</span> %</div>
    <div>Druck: <span id="press" class="value">â€“</span> hPa</div>
    <div id="weatherIcon"></div>
</div>

<div class="card">
    <h3>Temperatur â€“ letzte 24h</h3>
    <canvas id="tempChart"></canvas>
    Max: <span id="tempMax">â€“</span> Â°C  
    Min: <span id="tempMin">â€“</span> Â°C
</div>

<div class="card">
    <h3>Feuchte â€“ letzte 24h</h3>
    <canvas id="humDay"></canvas>
</div>

<div class="card">
    <h3>Druck â€“ letzte 24h</h3>
    <canvas id="pressDay"></canvas>
</div>

<div class="card">
    <h3>Temperatur â€“ Woche</h3>
    <canvas id="tempWeek"></canvas>
</div>

<div class="card">
    <h3>Temperatur â€“ Monat</h3>
    <canvas id="tempMonth"></canvas>
</div>

<div class="card">
    <h3>JahresÃ¼bersicht</h3>
    <select id="yearSelect"></select>
    <canvas id="yearChart"></canvas>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* Firebase Config */
const firebaseConfig = {
    apiKey: "AIzaSyAfIU041dyNBiCC_ywpJiwf8mABJVsT-lw",
    authDomain: "meine-wetterstation.firebaseapp.com",
    databaseURL: "https://meine-wetterstation-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "meine-wetterstation",
    storageBucket: "meine-wetterstation.appspot.com",
    messagingSenderId: "593494014586",
    appId: "1:593494014586:web:a05ed68495b1b16d6059c3",
    measurementId: "G-ST9RCRW888"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* Smart Weather Icon */
let lastPressure = null;
let lastPressureTime = null;

function updateWeatherIcon(temp, hum, pressure) {
    const iconDiv = document.getElementById("weatherIcon");
    iconDiv.innerHTML = "";

    let icon = "fa-cloud";
    let color = "#888";

    if (hum > 95 && temp > -2 && temp < 10) {
        icon = "fa-smog";
        color = "#999";
    } else if (temp < -5 && hum > 80) {
        icon = "fa-snowflake";
        color = "#00aaff";
    } else if (temp < 0 && hum > 70) {
        icon = "fa-snowflake";
        color = "#66ccff";
    } else if (hum > 85) {
        icon = "fa-cloud-showers-heavy";
        color = "#0077cc";
    } else if (temp > 20 && hum < 70) {
        icon = "fa-sun";
        color = "#FFD700";
    } else if (lastPressure !== null && pressure !== null) {
        const dt = Date.now() - lastPressureTime;
        if (dt < 30 * 60 * 1000 && lastPressure - pressure > 3) {
            icon = "fa-wind";
            color = "#00aaff";
        }
    }

    const i = document.createElement("i");
    i.className = "fa-solid " + icon;
    i.style.fontSize = "2.2rem";
    i.style.color = color;

    iconDiv.appendChild(i);

    lastPressure = pressure;
    lastPressureTime = Date.now();
}

/* Trend */
function updateTrend(id, current, last) {
    const el = document.getElementById(id);
    if (last === null) return;

    if (current > last) el.className = "fa-solid fa-arrow-up trend";
    else if (current < last) el.className = "fa-solid fa-arrow-down trend";
    else el.className = "fa-solid fa-minus trend";
}

/* Live-Werte */
let lastTemp = null;
let lastHum = null;
let lastPress = null;

db.ref("weather/temperature").on("value", s => {
    const v = s.val();
    document.getElementById("temp").textContent = v.toFixed(1);
    updateTrend("tempTrend", v, lastTemp);
    lastTemp = v;
    updateWeatherIcon(lastTemp, lastHum, lastPress);
});

db.ref("weather/humidity").on("value", s => {
    lastHum = s.val();
    document.getElementById("hum").textContent = lastHum;
    updateWeatherIcon(lastTemp, lastHum, lastPress);
});

db.ref("weather/pressure").on("value", s => {
    lastPress = s.val();
    document.getElementById("press").textContent = lastPress;
    updateWeatherIcon(lastTemp, lastHum, lastPress);
});

/* Charts */
function createChart(id, label, color) {
    return new Chart(document.getElementById(id).getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [{ label, data: [], borderColor: color, backgroundColor: color + "33", tension: 0.3 }] }
    });
}

const tempChart = createChart("tempChart", "Temperatur (Â°C)", "#ff3333");
const humDay = createChart("humDay", "Feuchte (%)", "#ff8800");
const pressDay = createChart("pressDay", "Druck (hPa)", "#0033cc");
const tempWeek = createChart("tempWeek", "Temperatur (Â°C)", "#ff3333");
const tempMonth = createChart("tempMonth", "Temperatur (Â°C)", "#ff3333");

/* History */
const now = Math.floor(Date.now() / 1000);
const since24h = now - 86400;
const sinceWeek = now - 7 * 86400;
const sinceMonth = now - 30 * 86400;

let tempValues = [];

function addHistory(ref, chart, since, callback) {
    db.ref(ref).orderByKey().startAt(String(since)).on("child_added", snap => {
        const ts = snap.key;
        const val = snap.val();

        const time = new Date(ts * 1000).toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" });

        chart.data.labels.push(time);
        chart.data.datasets[0].data.push(val);
        chart.update();

        if (callback) callback(val);
    });
}

addHistory("history/temperature", tempChart, since24h, val => {
    tempValues.push(val);
    document.getElementById("tempMax").textContent = Math.max(...tempValues).toFixed(1);
    document.getElementById("tempMin").textContent = Math.min(...tempValues).toFixed(1);
});

addHistory("history/humidity", humDay, since24h);
addHistory("history/pressure", pressDay, since24h);

addHistory("history/temperature", tempWeek, sinceWeek);
addHistory("history/temperature", tempMonth, sinceMonth);

/* Jahresdiagramm */
let yearChart = null;

function loadYears() {
    db.ref("history/year").once("value", snap => {
        const years = Object.keys(snap.val() || {});
        const select = document.getElementById("yearSelect");

        years.forEach(y => {
            const opt = document.createElement("option");
            opt.value = y;
            opt.textContent = y;
            select.appendChild(opt);
        });

        if (years.length > 0) {
            loadYearData(years[years.length - 1]);
        }
    });
}

function loadYearData(year) {
    if (yearChart) yearChart.destroy();

    const monthsMin = Array(12).fill(null);
    const monthsMax = Array(12).fill(null);

    db.ref("history/year/" + year + "/temperature").once("value", snap => {
        snap.forEach(child => {
            const ts = Number(child.key);
            const val = child.val();
            const m = new Date(ts * 1000).getMonth();

            if (monthsMin[m] === null || val < monthsMin[m]) monthsMin[m] = val;
            if (monthsMax[m] === null || val > monthsMax[m]) monthsMax[m] = val;
        });

        const ctx = document.getElementById("yearChart").getContext("2d");

        yearChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: ["Jan","Feb","MÃ¤r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],
                datasets: [
                    {
                        label: "Min",
                        data: monthsMin,
                        backgroundColor: "#99ccff",
                        borderColor: "#3399ff",
                        borderWidth: 1
                    },
                    {
                        label: "Max",
                        data: monthsMax,
                        type: "line",
                        borderColor: "#ff3333",
                        borderWidth: 3,
                        fill: false,
                        tension: 0.3
                    }
                ]
            }
        });
    });
}

document.getElementById("yearSelect").addEventListener("change", e => {
    loadYearData(e.target.value);
});

loadYears();
</script>

</body>
</html>

const ESP_URL = "http://192.168.1.200";

let tempData = [];
let humData = [];
let presData = [];
let timeLabels = [];

let tempChart, humChart, presChart;

async function loadData() {
    try {
        const res = await fetch(ESP_URL + "?t=" + Date.now());
        const d = await res.json();

        // Zeitstempel erzeugen
        const now = new Date().toLocaleTimeString();

        // Werte speichern
        timeLabels.push(now);
        tempData.push(d.temperature);
        humData.push(d.humidity);
        presData.push(d.pressure);

        // Maximal 50 Punkte behalten
        if (timeLabels.length > 50) {
            timeLabels.shift();
            tempData.shift();
            humData.shift();
            presData.shift();
        }

        updateLiveStats(d);
        updateCharts();

    } catch (err) {
        console.error("ESP nicht erreichbar:", err);
    }
}

function updateLiveStats(d) {
    document.getElementById("tempStats").innerHTML =
        `Aktuell: <b>${d.temperature.toFixed(1)}°C</b>`;

    document.getElementById("humStats").innerHTML =
        `Aktuell: <b>${d.humidity.toFixed(1)}%</b>`;

    document.getElementById("presStats").innerHTML =
        `Aktuell: <b>${d.pressure.toFixed(1)} hPa</b>`;
}

function updateCharts() {
    if (!tempChart) {
        tempChart = new Chart(document.getElementById("tempChart"), {
            type: "line",
            data: {
                labels: timeLabels,
                datasets: [{
                    label: "Temperatur (°C)",
                    data: tempData,
                    borderColor: "#ff7043",
                    tension: 0.3
                }]
            }
        });
    } else {
        tempChart.data.labels = timeLabels;
        tempChart.data.datasets[0].data = tempData;
        tempChart.update();
    }

    if (!humChart) {
        humChart = new Chart(document.getElementById("humChart"), {
            type: "line",
            data: {
                labels: timeLabels,
                datasets: [{
                    label: "Feuchtigkeit (%)",
                    data: humData,
                    borderColor: "#42a5f5",
                    tension: 0.3
                }]
            }
        });
    } else {
        humChart.data.labels = timeLabels;
        humChart.data.datasets[0].data = humData;
        humChart.update();
    }

    if (!presChart) {
        presChart = new Chart(document.getElementById("presChart"), {
            type: "line",
            data: {
                labels: timeLabels,
                datasets: [{
                    label: "Luftdruck (hPa)",
                    data: presData,
                    borderColor: "#66bb6a",
                    tension: 0.3
                }]
            }
        });
    } else {
        presChart.data.labels = timeLabels;
        presChart.data.datasets[0].data = presData;
        presChart.update();
    }
}

// Dark Mode
document.getElementById("darkToggle").addEventListener("click", () => {
    document.body.classList.toggle("dark");
});

// Tabs (nur optisch)
document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
    });
});

// Daten alle 5 Sekunden laden
loadData();
setInterval(loadData, 5000);
